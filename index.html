<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>KCR ì»¤í•‘ì•± v3.0</title>
<style>
:root{--bg:#000;--panel:#1a1a1a;--text:#fff;--border:#333}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{background:var(--bg);color:var(--text);font-family:-apple-system,sans-serif;font-size:16px;height:100dvh;overflow:hidden}
.panel{display:none;padding:20px;max-height:100dvh;overflow-y:auto}
.panel.active{display:block}
.btn{width:100%;padding:16px;background:#fff;color:#000;border:none;border-radius:8px;font-weight:600;font-size:16px;cursor:pointer;margin-bottom:12px}
.btn:disabled{background:#555;color:#999;cursor:not-allowed}
.btn-outline{width:100%;padding:16px;background:transparent;color:#fff;border:2px solid var(--border);border-radius:8px;font-weight:600;cursor:pointer;margin-bottom:12px}
input,textarea,select{width:100%;padding:14px;background:#1a1a1a;border:1px solid var(--border);border-radius:8px;color:#fff;font-size:16px;margin-bottom:16px}
textarea{min-height:100px;resize:vertical;font-family:inherit}
.toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:#fff;color:#000;padding:16px 24px;border-radius:8px;font-weight:600;z-index:10000;display:none}
.toast.show{display:block;animation:fadein .3s}
.toast.error{background:#ff4444;color:#fff}
@keyframes fadein{from{bottom:0;opacity:0}to{bottom:30px;opacity:1}}
.overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100dvh;background:rgba(0,0,0,.8);z-index:9999;align-items:center;justify-content:center}
.overlay.active{display:flex}
.spinner{border:4px solid #333;border-top:4px solid #fff;border-radius:50%;width:48px;height:48px;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

.eval-container{display:none;flex-direction:column;height:100dvh;position:fixed;top:0;left:0;right:0;bottom:0;z-index:100;background:var(--bg)}
.eval-container.active{display:flex}
.eval-header{background:#1a1a1a;border-bottom:2px solid var(--border);padding:16px;display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
.eval-title{font-size:20px;font-weight:700}
.eval-total{font-size:28px;font-weight:700}
.cup-nav-top{background:#1a1a1a;border-bottom:2px solid var(--border);padding:12px;display:flex;gap:8px;overflow-x:auto;flex-shrink:0;align-items:center}
.cup-nav-left{display:flex;gap:8px;overflow-x:auto;flex:1}
.cup-nav-right{display:flex;gap:8px;flex-shrink:0;margin-left:12px}
.cup-nav-btn{min-width:70px;height:60px;background:#2a2a2a;border:2px solid var(--border);border-radius:8px;color:#999;font-size:14px;font-weight:700;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;flex-shrink:0}
.cup-nav-btn.active{background:#fff;color:#000;border-color:#fff}
.cup-nav-num{font-size:16px}
.cup-nav-score{font-size:11px;margin-top:4px}
.submit-nav-btn{padding:12px 16px;background:#fff;color:#000;border:none;border-radius:8px;font-weight:700;font-size:14px;cursor:pointer;white-space:nowrap;height:60px;display:flex;align-items:center}
.submit-nav-btn:disabled{background:#555;color:#999;cursor:not-allowed}
.eval-content{flex:1;overflow-y:auto;padding:16px;padding-bottom:60px}
.attr-tabs{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:20px;background:#2a2a2a;padding:10px;border-radius:10px}
.attr-tab{padding:12px 8px;background:#1a1a1a;border:2px solid var(--border);border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;text-align:center;min-height:48px;display:flex;align-items:center;justify-content:center}
.attr-tab.active{background:#fff;color:#000;border-color:#fff}
.attr-tab.filled{border-color:#fff;background:rgba(255,255,255,0.1)}
.attr-card{background:#2a2a2a;border-radius:12px;padding:16px;margin-bottom:20px;border:2px solid var(--border)}
.score-display{text-align:center;font-size:48px;font-weight:700;margin-bottom:8px}
.score-meaning{text-align:center;font-size:16px;color:#999;margin-bottom:16px;font-weight:600}
.sweetness-multiplier{text-align:center;font-size:14px;color:#999;margin-bottom:16px}
.score-slider{-webkit-appearance:none;width:100%;height:8px;border-radius:5px;background:#333;outline:none}
.score-slider::-webkit-slider-thumb{-webkit-appearance:none;width:28px;height:28px;border-radius:50%;background:#fff;cursor:pointer}
.score-slider:disabled{opacity:0.5;cursor:not-allowed}
.score-slider:disabled::-webkit-slider-thumb{cursor:not-allowed;background:#777}
.score-labels{display:flex;justify-content:space-between;color:#999;font-size:12px;margin-top:8px}
.score-lock{display:flex;align-items:center;justify-content:center;margin-top:16px;padding:12px;background:rgba(255,255,255,0.05);border-radius:6px}
.score-lock input[type="checkbox"]{width:auto;margin:0 8px 0 0}
.score-lock label{color:#999;font-size:14px;cursor:pointer;margin:0}
.intensity-label{text-align:center;font-weight:600;margin-bottom:12px;color:#999;font-size:14px;margin-top:20px}
.intensity-grid{display:flex;gap:8px;overflow-x:auto;padding-bottom:8px}
.intensity-btn{padding:12px 10px;background:#1a1a1a;border:2px solid var(--border);border-radius:6px;cursor:pointer;font-weight:600;font-size:11px;text-align:center;min-height:56px;min-width:65px;display:flex;flex-direction:column;align-items:center;justify-content:center;flex-shrink:0}
.intensity-btn.selected{background:#fff;color:#000;border-color:#fff}
.smart-tags-section{background:rgba(255,255,255,0.03);border:2px solid #555;border-radius:8px;padding:16px;margin:20px 0}
.smart-tags-title{font-weight:700;margin-bottom:8px;font-size:15px}
.smart-tags-hint{font-size:12px;color:#999;margin-bottom:12px}
.selected-tags{display:flex;flex-wrap:wrap;gap:8px;margin:12px 0;min-height:32px}
.selected-tag{background:#fff;color:#000;padding:6px 12px;border-radius:6px;font-size:12px;cursor:pointer;font-weight:600}
.category-primary{display:flex;flex-wrap:wrap;gap:8px;margin:12px 0}
.category-btn-primary{background:#1a1a1a;border:2px solid var(--border);padding:10px 14px;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600}
.category-btn-primary.selected{background:#fff;color:#000;border-color:#fff}
.category-secondary{display:none;flex-wrap:wrap;gap:6px;margin:8px 0;padding:12px;background:rgba(0,0,0,0.3);border-radius:6px}
.category-secondary.active{display:flex}
.category-btn-secondary{background:#2a2a2a;border:1px solid var(--border);padding:8px 12px;border-radius:4px;cursor:pointer;font-size:12px;font-weight:600}
.category-btn-secondary.selected{background:#fff;color:#000;border-color:#fff}
.category-tertiary{display:none;flex-wrap:wrap;gap:6px;margin:8px 0;padding:10px;background:rgba(0,0,0,0.5);border-radius:6px}
.category-tertiary.active{display:flex}
.category-btn-tertiary{background:#1a1a1a;border:1px solid var(--border);padding:6px 10px;border-radius:4px;cursor:pointer;font-size:11px}
.category-btn-tertiary.selected{background:#fff;color:#000;border-color:#fff}
.category-btn-tertiary.conflict{background:#ff4444;color:#fff;border-color:#ff4444;opacity:0.5;cursor:not-allowed}
.category-btn-secondary.conflict{background:#ff4444;color:#fff;border-color:#ff4444;opacity:0.5;cursor:not-allowed}
.btn-assistant{width:100%;padding:14px;background:#fff;color:#000;border:none;border-radius:6px;font-size:14px;font-weight:600;cursor:pointer;margin:16px 0}
.btn-assistant:disabled{background:#555;color:#999;cursor:not-allowed}
.generated-comments-area{margin-top:16px;padding:12px;background:rgba(255,255,255,0.05);border-radius:6px;display:none}
.generated-comments-area.active{display:block}
.comment-variation{background:#2a2a2a;border:1px solid var(--border);padding:12px;margin:8px 0;border-radius:6px;cursor:pointer;font-size:14px;line-height:1.6}
.comment-variation:hover{border-color:#fff}
.comment-label{display:block;margin-bottom:8px;font-weight:600;color:#999;font-size:14px;margin-top:20px;padding-top:20px;border-top:2px solid #555}
.verification-result{margin-top:16px;padding:16px;border-radius:8px;border:2px solid var(--border);display:none}
.verification-result.active{display:block}
.verification-result.critical{border-color:#ff4444;background:rgba(255,68,68,0.1)}
.verification-result.critical .verification-issue{color:#ff4444}
.verification-result.high{border-color:#ffaa00;background:rgba(255,170,0,0.1)}
.verification-result.high .verification-issue{color:#ffaa00}
.verification-result.medium{border-color:#ffaa00;background:rgba(255,170,0,0.05)}
.verification-result.medium .verification-issue{color:#ffaa00}
.verification-result.none{border-color:#00ff88;background:rgba(0,255,136,0.05)}
.verification-result.none .verification-issue{color:#00ff88}
.verification-issue{font-weight:600;margin-bottom:8px;font-size:14px}
.verification-suggestion{font-size:13px;color:#999;line-height:1.5}
h2,h3{text-align:center;margin-bottom:20px;font-weight:700;font-size:22px}
h3{font-size:18px;margin:24px 0 16px 0}
.oneshot-container{background:rgba(255,255,255,0.05);border:2px solid #fff;border-radius:12px;padding:20px;margin:20px 0}
.review-item{background:#2a2a2a;border:2px solid var(--border);border-radius:8px;padding:16px;margin-bottom:12px;cursor:pointer}
.review-item:hover{border-color:#fff}
.cal-cup-group{background:#2a2a2a;border:2px solid var(--border);border-radius:8px;padding:16px;margin-bottom:16px}
.cal-stats{background:#1a1a1a;padding:12px;margin:8px 0 16px 0;border-radius:6px;border:1px solid var(--border)}
.cal-stats-title{font-size:14px;font-weight:700;margin-bottom:8px;color:#999}
.cal-stats-row{display:flex;justify-content:space-between;margin:4px 0;font-size:13px}
.cal-judge-row{background:#1a1a1a;padding:12px;margin:8px 0;border-radius:6px;border:1px solid var(--border)}
.cal-judge-row strong{color:#fff;font-size:16px}
.cal-scores{color:#999;font-size:13px;margin-top:8px}
.review-attr{background:#2a2a2a;border:2px solid var(--border);border-radius:8px;padding:16px;margin-bottom:16px}
.review-attr h4{margin-bottom:12px;font-size:16px;font-weight:700}
.cup-detail-card{background:#2a2a2a;border:2px solid var(--border);border-radius:8px;padding:16px;margin-bottom:12px}
.cup-detail-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.cup-detail-judge{font-size:16px;font-weight:700}
.cup-detail-total{font-size:24px;font-weight:700;color:#00ff88}
.cup-detail-scores{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:12px}
.cup-detail-score-item{background:#1a1a1a;padding:8px;border-radius:4px}
.cup-detail-score-label{font-size:11px;color:#999;margin-bottom:4px}
.cup-detail-score-value{font-size:14px;font-weight:600}
.cup-detail-comments{border-top:1px solid #444;padding-top:12px;margin-top:12px}
.cup-detail-comment{font-size:12px;color:#999;margin-bottom:6px;line-height:1.4}
.auto-save-indicator{position:fixed;bottom:20px;right:20px;background:#00ff88;color:#000;padding:8px 16px;border-radius:20px;font-size:12px;font-weight:600;z-index:9998;display:none}
.auto-save-indicator.active{display:block;animation:fadeInOut 2s}
@keyframes fadeInOut{0%,100%{opacity:0}10%,90%{opacity:1}}
.role-badge{display:inline-block;background:#fff;color:#000;padding:6px 14px;border-radius:6px;font-size:11px;font-weight:700;margin-left:12px;letter-spacing:0.5px}
</style>
</head>
<body>

<div id="overlay" class="overlay"><div class="spinner"></div></div>
<div id="toast" class="toast"></div>
<div id="autoSaveIndicator" class="auto-save-indicator">ìë™ ì €ì¥ë¨ âœ“</div>

<div id="loginScreen" class="panel active">
  <h2>KCR ì»¤í•‘ì•± v3.0</h2>
  <input type="text" id="loginName" placeholder="ì´ë¦„">
  <input type="tel" id="loginPhone" placeholder="ì „í™”ë²ˆí˜¸">
  <button class="btn" onclick="doLogin()">ë¡œê·¸ì¸</button>
</div>

<div id="adminScreen" class="panel">
  <h2>ê´€ë¦¬ì</h2>
  <p style="text-align:center;color:#999;margin-bottom:24px"><span id="adminUserName"></span><span class="role-badge">ê´€ë¦¬ì</span></p>
  <button class="btn" onclick="loadAllCompletedReviews()">âœ… ê²€ìˆ˜ ì™„ë£Œ ëª©ë¡</button>
  <button class="btn-outline" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
  <h3>TOP 20 ìˆœìœ„</h3>
  <button class="btn" onclick="downloadPDF()" style="margin-bottom:16px">ğŸ“„ TOP 20 PDF ë‹¤ìš´ë¡œë“œ</button>
  <div id="top50Area"></div>
</div>

<div id="completedListScreen" class="panel">
  <h2>ê²€ìˆ˜ ì™„ë£Œ ëª©ë¡</h2>
  <div id="completedListArea"></div>
  <button class="btn-outline" onclick="backHome()">ë’¤ë¡œê°€ê¸°</button>
</div>

<div id="completedDetailScreen" class="panel">
  <h2>ê²€ìˆ˜ ì™„ë£Œ ìƒì„¸</h2>
  <div id="completedDetailArea"></div>
  <button class="btn-outline" onclick="showScreen('completedListScreen')">ëª©ë¡ìœ¼ë¡œ</button>
</div>

<div id="cupDetailScreen" class="panel">
  <h2>ì»µë³„ ìƒì„¸ í‰ê°€</h2>
  <div id="cupDetailArea"></div>
  <button class="btn" onclick="downloadCupPDF()">ğŸ“„ ì´ ì»µ PDF ë‹¤ìš´ë¡œë“œ</button>
  <button class="btn-outline" onclick="backHome()">ë’¤ë¡œê°€ê¸°</button>
</div>

<div id="headScreen" class="panel">
  <h2>í—¤ë“œ ì‹¬ì‚¬ìœ„ì›</h2>
  <p style="text-align:center;color:#999;margin-bottom:24px"><span id="headUserName"></span><span class="role-badge">í—¤ë“œì‹¬ì‚¬ìœ„ì›</span></p>
  <div class="oneshot-container">
    <div style="text-align:center;font-size:20px;font-weight:700;margin-bottom:16px">í‰ê°€ ì‹œì‘</div>
    <input type="number" id="headStartCup" placeholder="ì‹œì‘ ì»µ ë²ˆí˜¸">
    <input type="number" id="headEndCup" placeholder="ë§ˆì§€ë§‰ ì»µ ë²ˆí˜¸">
    <select id="headProcess" style="margin-bottom:16px">
      <option value="">í”„ë¡œì„¸ìŠ¤ ì„ íƒ</option>
      <option value="Washed">Washed Process</option>
      <option value="Natural">Natural Process</option>
    </select>
    <select id="headMode">
      <option value="judge">Judge ëª¨ë“œ</option>
      <option value="calibration">Calibration ëª¨ë“œ</option>
    </select>
    <button class="btn" onclick="startEvalByHead()">í‰ê°€ ì‹œì‘</button>
  </div>
  <button class="btn-outline" onclick="loadCalibrationCups()">Calibration ê²°ê³¼</button>
  <button class="btn-outline" onclick="loadReviews()">ê²€ìˆ˜ ëŒ€ê¸° ëª©ë¡</button>
  <button class="btn-outline" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
</div>

<div id="judgeScreen" class="panel">
  <h2>ì‹¬ì‚¬ìœ„ì›</h2>
  <p style="text-align:center;color:#999;margin-bottom:24px"><span id="judgeUserName"></span><span class="role-badge">ì‹¬ì‚¬ìœ„ì›</span></p>
  <div class="oneshot-container">
    <div style="text-align:center;font-size:20px;font-weight:700;margin-bottom:16px">í‰ê°€ ì‹œì‘</div>
    <input type="number" id="judgeStartCup" placeholder="ì‹œì‘ ì»µ ë²ˆí˜¸">
    <input type="number" id="judgeEndCup" placeholder="ë§ˆì§€ë§‰ ì»µ ë²ˆí˜¸">
    <select id="judgeProcess" style="margin-bottom:16px">
      <option value="">í”„ë¡œì„¸ìŠ¤ ì„ íƒ</option>
      <option value="Washed">Washed Process</option>
      <option value="Natural">Natural Process</option>
    </select>
    <select id="judgeMode">
      <option value="judge">Judge ëª¨ë“œ</option>
      <option value="calibration">Calibration ëª¨ë“œ</option>
    </select>
    <button class="btn" onclick="startEvalByJudge()">í‰ê°€ ì‹œì‘</button>
  </div>
  <button class="btn-outline" onclick="loadReviews()">ê²€ìˆ˜ ëŒ€ê¸° ëª©ë¡</button>
  <button class="btn-outline" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
</div>

<div id="calListScreen" class="panel">
  <h2>Calibration ê²°ê³¼</h2>
  <div id="calCupList"></div>
  <button class="btn-outline" onclick="backHome()">ë’¤ë¡œê°€ê¸°</button>
</div>

<div id="calResultScreen" class="panel">
  <h2>Calibration ìƒì„¸</h2>
  <div id="calResultArea"></div>
  <button class="btn-outline" onclick="showScreen('calListScreen')">ëª©ë¡ìœ¼ë¡œ</button>
</div>

<div id="reviewListScreen" class="panel">
  <h2>ê²€ìˆ˜ ëŒ€ê¸°</h2>
  <div id="reviewListArea"></div>
  <button class="btn-outline" onclick="backHome()">ë’¤ë¡œê°€ê¸°</button>
</div>

<div id="reviewDetailScreen" class="panel">
  <h2>ê²€ìˆ˜ ë° ìˆ˜ì •</h2>
  <div id="reviewDetailArea"></div>
  <button class="btn" onclick="saveReview()">ê²€ìˆ˜ ì™„ë£Œ</button>
  <button class="btn-outline" onclick="backToReviewList()">ì·¨ì†Œ</button>
</div>

<div id="evalContainer" class="eval-container">
  <div class="eval-header">
    <div class="eval-title"><span id="currentCupNum">Cup -</span></div>
    <div class="eval-total" id="evalTotalScore">0.00</div>
  </div>
  <div class="cup-nav-top">
    <div class="cup-nav-left" id="cupNavigation"></div>
    <div class="cup-nav-right">
      <button class="submit-nav-btn" onclick="handleSubmitClick()" id="submitNavBtn">ì œì¶œì™„ë£Œ</button>
    </div>
  </div>
  <div class="eval-content">
    <div class="attr-tabs" id="attrTabs">
      <div class="attr-tab active" data-attr="flavor">Flavor</div>
      <div class="attr-tab" data-attr="aftertaste">Aftertaste</div>
      <div class="attr-tab" data-attr="acidity">Acidity</div>
      <div class="attr-tab" data-attr="body">Body</div>
      <div class="attr-tab" data-attr="sweetness">Sweetness</div>
      <div class="attr-tab" data-attr="overall">Overall</div>
    </div>
    <div id="attrCardArea"></div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
var currentUser=null;
var evalData={cups:[],currentCupIndex:0,currentAttr:'flavor',startCup:0,endCup:0,mode:''};
var currentReviewData=null;
var isSubmitting=false;
var MAX_TAGS=5;
var submitDebounceTimer=null;
var autoSaveTimer=null;
var currentCupDetailData=null;

// ===== v3.0: ìŠ¤ë§ˆíŠ¸íƒœê·¸ ê³„ì¸µ êµ¬ì¡° =====
var TAG_HIERARCHY={
  'ê³¼ì¼ê°™ì€':['ë² ë¦¬','ë§ë¦° ê³¼ì¼','ê¸°íƒ€ ê³¼ì¼','ê°ê·¤ë¥˜'],
  'ë² ë¦¬':['ë¸”ë™ë² ë¦¬','ìŠ¤íŠ¸ë¡œë² ë¦¬','ë¸”ë£¨ë² ë¦¬','í¬ëœë² ë¦¬'],
  'ë§ë¦° ê³¼ì¼':['ê±´í¬ë„','ë§ë¦° ìë‘'],
  'ê¸°íƒ€ ê³¼ì¼':['ì½”ì½”ë„›','ì²´ë¦¬','ì„ë¥˜','íŒŒì¸ì• í”Œ','í¬ë„','ì‚¬ê³¼','ë³µìˆ­ì•„','ë°°'],
  'ê°ê·¤ë¥˜':['ìëª½','ì˜¤ë Œì§€','ë ˆëª¬','ë¼ì„'],
  'ê½ƒí–¥':['í™ì°¨','ìºëª¨ë§ˆì¼','ì¥ë¯¸','ììŠ¤ë¯¼'],
  'ë‹¬ì½¤í•œ':['ë¸Œë¼ìš´ìŠˆê±°','ë°”ë‹ë¼','ë©”ì´í”Œì‹œëŸ½','ìºëŸ¬ë©œ','ê¿€'],
  'ë°œíš¨ëœ':['ì™€ì¸ ê°™ì€','ìœ„ìŠ¤í‚¤','ë°œíš¨ëœ','ê³¼ìˆ™í•œ'],
  'ë…¹ìƒ‰/ì±„ì†Œê°™ì€':['ëœ ìµì€','í’‹ë‚´','ì±„ì†Œ ê°™ì€','ê±´ì´ˆ ê°™ì€','í—ˆë¸Œ ê°™ì€'],
  'êµ¬ìš´':['ê³¡ë¥˜','íƒ„ ë“¯í•œ','ë‹´ë°° ê°™ì€','ë§¥ì•„','ê³¡ë¬¼','ë…¸ë¦‡í•˜ê²Œ êµ¬ìš´','ì—°ê¸° ê°™ì€','ì¬ ê°™ì€','ë§¤ìºí•œ'],
  'í–¥ì‹ ë£Œ':['ì •í–¥','ì‹œë‚˜ëª¬','ìœ¡ë‘êµ¬','ì•„ë‹ˆìŠ¤','í›„ì¶”','í†¡ ì˜ëŠ”'],
  'ê²¬ê³¼ë¥˜':['ì•„ëª¬ë“œ','í—¤ì´ì¦ë„›','ë•…ì½©'],
  'ì½”ì½”ì•„':['ë‹¤í¬ ì´ˆì½œë¦¿','ì´ˆì½œë¦¿','ì¹´ì¹´ì˜¤']
};

var ATTRIBUTE_CONFLICTS={
  body:{
    'ê±°ì¹œ':['ë¶€ë“œëŸ¬ìš´','ë²¨ë²³ ê°™ì€','ë§¤ë„ëŸ¬ìš´','ì‹¤í‚¤í•œ','í¬ë¦¬ë¯¸í•œ'],
    'í…í…í•œ':['ë¶€ë“œëŸ¬ìš´','ë²¨ë²³ ê°™ì€','ë§¤ë„ëŸ¬ìš´','ì‹¤í‚¤í•œ','í¬ë¦¬ë¯¸í•œ','í´ë¦°í•œ'],
    'ë¶€ë“œëŸ¬ìš´':['ê±°ì¹œ','í…í…í•œ','ì…ì•ˆì´ ë§ˆë¥´ëŠ”','ë“œë¼ì´','ê¸ˆì†ì„±'],
    'ë²¨ë²³ ê°™ì€':['ê±°ì¹œ','í…í…í•œ','ì…ì•ˆì´ ë§ˆë¥´ëŠ”','ë“œë¼ì´'],
    'ë§¤ë„ëŸ¬ìš´':['ê±°ì¹œ','í…í…í•œ','ê¸ˆì†ì„±'],
    'ì‹¤í‚¤í•œ':['ê±°ì¹œ','í…í…í•œ','ê¸ˆì†ì„±'],
    'ì‹œëŸ½ê°™ì€':['ë“œë¼ì´','ì…ì•ˆì´ ë§ˆë¥´ëŠ”'],
    'ê¸ˆì†ì„±':['ë¶€ë“œëŸ¬ìš´','ë²¨ë²³ ê°™ì€','ë§¤ë„ëŸ¬ìš´','ì‹¤í‚¤í•œ','í¬ë¦¬ë¯¸í•œ'],
    'ê¸°ë¦„ì§„':['ë“œë¼ì´','ì…ì•ˆì´ ë§ˆë¥´ëŠ”','í´ë¦°í•œ'],
    'í´ë¦°í•œ':['í…í…í•œ','ê¸°ë¦„ì§„','ê¸ˆì†ì„±'],
    'ì…ì•ˆì´ ë§ˆë¥´ëŠ”':['ë¶€ë“œëŸ¬ìš´','ë²¨ë²³ ê°™ì€','ì‹œëŸ½ê°™ì€','ê¸°ë¦„ì§„'],
    'ë“œë¼ì´':['ë¶€ë“œëŸ¬ìš´','ì‹œëŸ½ê°™ì€','ê¸°ë¦„ì§„','í¬ë¦¬ë¯¸í•œ']
  }
};

var INTENSITY_LEVELS={
  1:{label:'ë§¤ìš° ì•½í•¨',value:1},2:{label:'ì•½í•¨',value:2},3:{label:'ì•½ê°„ ì•½í•¨',value:3},
  4:{label:'ì¤‘ê°„',value:4},5:{label:'ì•½ê°„ ê°•í•¨',value:5},6:{label:'ê°•í•¨',value:6},7:{label:'ë§¤ìš° ê°•í•¨',value:7}
};

var SCORE_MEANINGS={
  0:'ë§¤ìš° ë¶€ì •ì ',0.25:'ë§¤ìš° ë¶€ì •ì ',0.5:'ë§¤ìš° ë¶€ì •ì ',0.75:'ë§¤ìš° ë¶€ì •ì ',
  1:'ë¶€ì •ì ',1.25:'ë¶€ì •ì ',1.5:'ë¶€ì •ì ',1.75:'ë¶€ì •ì ',
  2:'ë‹¤ì†Œ ë¶€ì¡±',2.25:'ë‹¤ì†Œ ë¶€ì¡±',2.5:'ë‹¤ì†Œ ë¶€ì¡±',2.75:'ë‹¤ì†Œ ë¶€ì¡±',
  3:'ë³´í†µ',3.25:'ë³´í†µ',3.5:'ë³´í†µ',3.75:'ë³´í†µ',
  4:'ì¢‹ìŒ',4.25:'ì¢‹ìŒ',4.5:'ì¢‹ìŒ',4.75:'ì¢‹ìŒ',5:'ë§¤ìš° ìš°ìˆ˜'
};

var SMART_TAGS={
  flavor:{
    'ê½ƒí–¥':{'í™ì°¨':['í™ì°¨'],'ê½ƒí–¥':['ìºëª¨ë§ˆì¼','ì¥ë¯¸','ììŠ¤ë¯¼']},
    'ê³¼ì¼ê°™ì€':{
      'ë² ë¦¬':['ë¸”ë™ë² ë¦¬','ìŠ¤íŠ¸ë¡œë² ë¦¬','ë¸”ë£¨ë² ë¦¬','í¬ëœë² ë¦¬'],
      'ë§ë¦° ê³¼ì¼':['ê±´í¬ë„','ë§ë¦° ìë‘'],
      'ê¸°íƒ€ ê³¼ì¼':['ì½”ì½”ë„›','ì²´ë¦¬','ì„ë¥˜','íŒŒì¸ì• í”Œ','í¬ë„','ì‚¬ê³¼','ë³µìˆ­ì•„','ë°°'],
      'ê°ê·¤ë¥˜':['ìëª½','ì˜¤ë Œì§€','ë ˆëª¬','ë¼ì„']
    },
    'ë‹¬ì½¤í•œ':{'ë‹¬ì½¤í•œ':['ë¸Œë¼ìš´ìŠˆê±°','ë°”ë‹ë¼','ë©”ì´í”Œì‹œëŸ½','ìºëŸ¬ë©œ','ê¿€']},
    'ë°œíš¨ëœ':{'ë°œíš¨ëœ':['ì™€ì¸ ê°™ì€','ìœ„ìŠ¤í‚¤','ë°œíš¨ëœ','ê³¼ìˆ™í•œ']},
    'ë…¹ìƒ‰/ì±„ì†Œê°™ì€':{'ë…¹ìƒ‰/ì±„ì†Œê°™ì€':['ëœ ìµì€','í’‹ë‚´','ì±„ì†Œ ê°™ì€','ê±´ì´ˆ ê°™ì€','í—ˆë¸Œ ê°™ì€']},
    'êµ¬ìš´':{
      'êµ¬ìš´':['ê³¡ë¥˜','íƒ„ ë“¯í•œ','ë‹´ë°° ê°™ì€','ë§¥ì•„','ê³¡ë¬¼','ë…¸ë¦‡í•˜ê²Œ êµ¬ìš´'],
      'ì—°ê¸°/ì¬':['ì—°ê¸° ê°™ì€','ì¬ ê°™ì€','ë§¤ìºí•œ']
    },
    'í–¥ì‹ ë£Œ':{'í–¥ì‹ ë£Œ':['ì •í–¥','ì‹œë‚˜ëª¬','ìœ¡ë‘êµ¬','ì•„ë‹ˆìŠ¤','í›„ì¶”','í†¡ ì˜ëŠ”']},
    'ê²¬ê³¼ë¥˜':{'ê²¬ê³¼ë¥˜':['ì•„ëª¬ë“œ','í—¤ì´ì¦ë„›','ë•…ì½©']},
    'ì½”ì½”ì•„':{'ì½”ì½”ì•„':['ë‹¤í¬ ì´ˆì½œë¦¿','ì´ˆì½œë¦¿','ì¹´ì¹´ì˜¤']},
    'ê¸°íƒ€':{'ê¸°íƒ€':['ë‚˜ë¬´ ê°™ì€','ê³°íŒ¡ì´','ì¢…ì´','í™”í•™ì ì¸','ê°ì','í™','ì˜¤ë˜ëœ']}
  },
  aftertaste:{
    'ê½ƒí–¥':{'í™ì°¨':['í™ì°¨'],'ê½ƒí–¥':['ìºëª¨ë§ˆì¼','ì¥ë¯¸','ììŠ¤ë¯¼']},
    'ê³¼ì¼ê°™ì€':{
      'ë² ë¦¬':['ë¸”ë™ë² ë¦¬','ìŠ¤íŠ¸ë¡œë² ë¦¬','ë¸”ë£¨ë² ë¦¬','í¬ëœë² ë¦¬'],
      'ë§ë¦° ê³¼ì¼':['ê±´í¬ë„','ë§ë¦° ìë‘'],
      'ê¸°íƒ€ ê³¼ì¼':['ì½”ì½”ë„›','ì²´ë¦¬','ì„ë¥˜','íŒŒì¸ì• í”Œ','í¬ë„','ì‚¬ê³¼','ë³µìˆ­ì•„','ë°°'],
      'ê°ê·¤ë¥˜':['ìëª½','ì˜¤ë Œì§€','ë ˆëª¬','ë¼ì„']
    },
    'ë‹¬ì½¤í•œ':{'ë‹¬ì½¤í•œ':['ë¸Œë¼ìš´ìŠˆê±°','ë°”ë‹ë¼','ë©”ì´í”Œì‹œëŸ½','ìºëŸ¬ë©œ','ê¿€']},
    'ë°œíš¨ëœ':{'ë°œíš¨ëœ':['ì™€ì¸ ê°™ì€','ìœ„ìŠ¤í‚¤','ë°œíš¨ëœ','ê³¼ìˆ™í•œ']},
    'ë…¹ìƒ‰/ì±„ì†Œê°™ì€':{'ë…¹ìƒ‰/ì±„ì†Œê°™ì€':['ëœ ìµì€','í’‹ë‚´','ì±„ì†Œ ê°™ì€','ê±´ì´ˆ ê°™ì€','í—ˆë¸Œ ê°™ì€']},
    'êµ¬ìš´':{
      'êµ¬ìš´':['ê³¡ë¥˜','íƒ„ ë“¯í•œ','ë‹´ë°° ê°™ì€','ë§¥ì•„','ê³¡ë¬¼','ë…¸ë¦‡í•˜ê²Œ êµ¬ìš´'],
      'ì—°ê¸°/ì¬':['ì—°ê¸° ê°™ì€','ì¬ ê°™ì€','ë§¤ìºí•œ']
    },
    'í–¥ì‹ ë£Œ':{'í–¥ì‹ ë£Œ':['ì •í–¥','ì‹œë‚˜ëª¬','ìœ¡ë‘êµ¬','ì•„ë‹ˆìŠ¤','í›„ì¶”','í†¡ ì˜ëŠ”']},
    'ê²¬ê³¼ë¥˜':{'ê²¬ê³¼ë¥˜':['ì•„ëª¬ë“œ','í—¤ì´ì¦ë„›','ë•…ì½©']},
    'ì½”ì½”ì•„':{'ì½”ì½”ì•„':['ë‹¤í¬ ì´ˆì½œë¦¿','ì´ˆì½œë¦¿','ì¹´ì¹´ì˜¤']},
    'ê¸°íƒ€':{'ê¸°íƒ€':['ë‚˜ë¬´ ê°™ì€','ê³°íŒ¡ì´','ì¢…ì´','í™”í•™ì ì¸','ê°ì','í™','ì˜¤ë˜ëœ']}
  },
  acidity:{
    'ê³¼ì¼ê°™ì€':{
      'ë² ë¦¬':['ë¸”ë™ë² ë¦¬','ìŠ¤íŠ¸ë¡œë² ë¦¬','ë¸”ë£¨ë² ë¦¬','í¬ëœë² ë¦¬'],
      'ë§ë¦° ê³¼ì¼':['ê±´í¬ë„','ë§ë¦° ìë‘'],
      'ê¸°íƒ€ ê³¼ì¼':['ì½”ì½”ë„›','ì²´ë¦¬','ì„ë¥˜','íŒŒì¸ì• í”Œ','í¬ë„','ì‚¬ê³¼','ë³µìˆ­ì•„','ë°°'],
      'ê°ê·¤ë¥˜':['ìëª½','ì˜¤ë Œì§€','ë ˆëª¬','ë¼ì„']
    },
    'ë°œíš¨ëœ':{'ë°œíš¨ëœ':['ì™€ì¸ ê°™ì€','ìœ„ìŠ¤í‚¤','ë°œíš¨ëœ','ê³¼ìˆ™í•œ']},
    'ë…¹ìƒ‰/ì±„ì†Œê°™ì€':{'ë…¹ìƒ‰/ì±„ì†Œê°™ì€':['ëœ ìµì€','í’‹ë‚´','ì±„ì†Œ ê°™ì€','ê±´ì´ˆ ê°™ì€','í—ˆë¸Œ ê°™ì€']},
    'ê¸°íƒ€':{'ê¸°íƒ€':['ë‚˜ë¬´ ê°™ì€','ê³°íŒ¡ì´','ì¢…ì´','í™”í•™ì ì¸','ê°ì','í™','ì˜¤ë˜ëœ']}
  },
  body:{
    'ì§ˆê°':['ê±°ì¹œ','í…í…í•œ','ë¶€ë“œëŸ¬ìš´','ë²¨ë²³ ê°™ì€','ë§¤ë„ëŸ¬ìš´','ì‹¤í‚¤í•œ','ì‹œëŸ½ê°™ì€','ê¸ˆì†ì„±','ê¸°ë¦„ì§„','í´ë¦°í•œ','ì…ì•ˆì´ ë§ˆë¥´ëŠ”','ë“œë¼ì´']
  },
  sweetness:{
    'ê³¼ì¼ê°™ì€':{
      'ë² ë¦¬':['ë¸”ë™ë² ë¦¬','ìŠ¤íŠ¸ë¡œë² ë¦¬','ë¸”ë£¨ë² ë¦¬','í¬ëœë² ë¦¬'],
      'ë§ë¦° ê³¼ì¼':['ê±´í¬ë„','ë§ë¦° ìë‘'],
      'ê¸°íƒ€ ê³¼ì¼':['ì½”ì½”ë„›','ì²´ë¦¬','ì„ë¥˜','íŒŒì¸ì• í”Œ','í¬ë„','ì‚¬ê³¼','ë³µìˆ­ì•„','ë°°'],
      'ê°ê·¤ë¥˜':['ìëª½','ì˜¤ë Œì§€','ë ˆëª¬','ë¼ì„']
    },
    'ë‹¬ì½¤í•œ':{'ë‹¬ì½¤í•œ':['ë¸Œë¼ìš´ìŠˆê±°','ë°”ë‹ë¼','ë©”ì´í”Œì‹œëŸ½','ìºëŸ¬ë©œ','ê¿€']},
    'ë°œíš¨ëœ':{'ë°œíš¨ëœ':['ì™€ì¸ ê°™ì€','ìœ„ìŠ¤í‚¤','ë°œíš¨ëœ','ê³¼ìˆ™í•œ']},
    'êµ¬ìš´':{
      'êµ¬ìš´':['ê³¡ë¥˜','íƒ„ ë“¯í•œ','ë‹´ë°° ê°™ì€','ë§¥ì•„','ê³¡ë¬¼','ë…¸ë¦‡í•˜ê²Œ êµ¬ìš´'],
      'ì—°ê¸°/ì¬':['ì—°ê¸° ê°™ì€','ì¬ ê°™ì€','ë§¤ìºí•œ']
    },
    'ê²¬ê³¼ë¥˜':{'ê²¬ê³¼ë¥˜':['ì•„ëª¬ë“œ','í—¤ì´ì¦ë„›','ë•…ì½©']},
    'í–¥ì‹ ë£Œ':{'í–¥ì‹ ë£Œ':['ì •í–¥','ì‹œë‚˜ëª¬','ìœ¡ë‘êµ¬','ì•„ë‹ˆìŠ¤','í›„ì¶”','í†¡ ì˜ëŠ”']},
    'ì½”ì½”ì•„':{'ì½”ì½”ì•„':['ë‹¤í¬ ì´ˆì½œë¦¿','ì´ˆì½œë¦¿','ì¹´ì¹´ì˜¤']}
  }
};

// ===== v3.0: ê³„ì¸µ êµ¬ì¡° ì¤‘ë³µ ì œê±° í•¨ìˆ˜ (ì™„ì „ ì¬ì‘ì„±) =====
function filterHierarchicalTags(tags, attrKey){
  var smartTagsStructure = SMART_TAGS[attrKey];
  if (!smartTagsStructure) return tags;
  
  var toRemove = {};
  var tagLevels = {}; // ê° íƒœê·¸ì˜ ë ˆë²¨ ì¶”ì 
  
  // ë¨¼ì € ê° íƒœê·¸ê°€ ì–´ëŠ ë ˆë²¨ì— ì†í•˜ëŠ”ì§€ íŒŒì•…
  for (var primary in smartTagsStructure) {
    tagLevels[primary] = 'primary';
    var secondaryObj = smartTagsStructure[primary];
    
    if (typeof secondaryObj === 'object' && !Array.isArray(secondaryObj)) {
      for (var secondary in secondaryObj) {
        tagLevels[secondary] = 'secondary';
        var tertiaryArr = secondaryObj[secondary];
        
        for (var i = 0; i < tertiaryArr.length; i++) {
          tagLevels[tertiaryArr[i]] = 'tertiary';
        }
      }
    }
  }
  
  // ê° Primary ì¹´í…Œê³ ë¦¬ë³„ë¡œ ì²˜ë¦¬
  for (var primary in smartTagsStructure) {
    var secondaryObj = smartTagsStructure[primary];
    
    if (typeof secondaryObj === 'object' && !Array.isArray(secondaryObj)) {
      var hasTertiary = false;
      var hasSecondary = false;
      var selectedSecondaries = [];
      
      // Tertiary íƒœê·¸ í™•ì¸
      for (var secondary in secondaryObj) {
        var tertiaryArr = secondaryObj[secondary];
        
        for (var i = 0; i < tertiaryArr.length; i++) {
          if (tags.indexOf(tertiaryArr[i]) > -1) {
            hasTertiary = true;
            // Tertiaryê°€ ì„ íƒë˜ì—ˆê³ , Secondaryì™€ ì´ë¦„ì´ ë‹¤ë¥´ë©´ Secondary ì œê±°
            if (tertiaryArr[i] !== secondary) {
              toRemove[secondary] = true;
            }
          }
        }
        
        // Secondary íƒœê·¸ í™•ì¸
        if (tags.indexOf(secondary) > -1) {
          hasSecondary = true;
          selectedSecondaries.push(secondary);
        }
      }
      
      // Primary ì œê±° ì¡°ê±´: í•˜ìœ„ íƒœê·¸ê°€ ìˆê³ , Primaryì™€ ì´ë¦„ì´ ë‹¤ë¥¸ ê²½ìš°ë§Œ
      if ((hasTertiary || hasSecondary) && tags.indexOf(primary) > -1) {
        var shouldRemovePrimary = false;
        
        // Primaryì™€ ë‹¤ë¥¸ ì´ë¦„ì˜ í•˜ìœ„ íƒœê·¸ê°€ ìˆìœ¼ë©´ Primary ì œê±°
        for (var secondary in secondaryObj) {
          if (tags.indexOf(secondary) > -1 && secondary !== primary) {
            shouldRemovePrimary = true;
            break;
          }
          
          var tertiaryArr = secondaryObj[secondary];
          for (var i = 0; i < tertiaryArr.length; i++) {
            if (tags.indexOf(tertiaryArr[i]) > -1 && tertiaryArr[i] !== primary) {
              shouldRemovePrimary = true;
              break;
            }
          }
          if (shouldRemovePrimary) break;
        }
        
        if (shouldRemovePrimary) {
          toRemove[primary] = true;
        }
      }
    }
  }
  
  // ì œê±° ëŒ€ìƒì´ ì•„ë‹Œ íƒœê·¸ë§Œ ë°˜í™˜
  var filtered = [];
  for (var i = 0; i < tags.length; i++) {
    if (!toRemove[tags[i]]) {
      filtered.push(tags[i]);
    }
  }
  
  return filtered;
}

function getScoreMeaning(score){
  var rounded=Math.round(score*4)/4;
  return SCORE_MEANINGS[rounded]||'ë³´í†µ';
}

function showOverlay(){document.getElementById('overlay').classList.add('active')}
function hideOverlay(){document.getElementById('overlay').classList.remove('active')}

function showToast(msg,isError){
  var t=document.getElementById('toast');
  t.innerText=msg;
  t.className='toast show'+(isError?' error':'');
  setTimeout(function(){t.className='toast'},3000);
}

function showScreen(screenId){
  var panels=document.querySelectorAll('.panel');
  panels.forEach(function(p){p.classList.remove('active')});
  if(screenId){
    var target=document.getElementById(screenId);
    if(target)target.classList.add('active');
  }
  document.getElementById('evalContainer').classList.remove('active');
}

function doLogin(){
  var name=document.getElementById('loginName').value.trim();
  var phone=document.getElementById('loginPhone').value.trim();
  if(!name||!phone){showToast('ì´ë¦„ê³¼ ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”',true);return}
  showOverlay();
  google.script.run
    .withSuccessHandler(function(res){
      hideOverlay();
      if(res.success){
        currentUser=res;
        restoreSession(res);
      }else{showToast(res.message,true)}
    })
    .withFailureHandler(function(err){hideOverlay();showToast('ë¡œê·¸ì¸ ì˜¤ë¥˜: '+err,true)})
    .loginUser(name,phone);
}

function restoreSession(user){
  currentUser=user;
  var savedEval=localStorage.getItem('kcr_eval_'+user.userID);
  if(savedEval){
    try{
      var parsed=JSON.parse(savedEval);
      if(confirm('ì¤‘ë‹¨ëœ í‰ê°€ë¥¼ ì´ì–´ì„œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì»µ: '+parsed.startCup+'~'+parsed.endCup)){
        evalData=parsed;
        renderCupNavigation();
        renderAttrCard();
        updateTotalScore();
        document.getElementById('evalContainer').classList.add('active');
        startAutoSave();
        return;
      }else{localStorage.removeItem('kcr_eval_'+user.userID)}
    }catch(e){localStorage.removeItem('kcr_eval_'+user.userID)}
  }
  if(user.role==='admin'){
    document.getElementById('adminUserName').innerText=user.name;
    showScreen('adminScreen');
    refreshTop50();
  }else if(user.role.indexOf('head')===0){
    document.getElementById('headUserName').innerText=user.name;
    showScreen('headScreen');
  }else{
    document.getElementById('judgeUserName').innerText=user.name;
    showScreen('judgeScreen');
  }
}

function logout(){
  stopAutoSave();
  if(currentUser)localStorage.removeItem('kcr_eval_'+currentUser.userID);
  currentUser=null;
  showScreen('loginScreen');
  showToast('ë¡œê·¸ì•„ì›ƒ');
}

function startEvalByHead(){
  var start=parseInt(document.getElementById('headStartCup').value);
  var end=parseInt(document.getElementById('headEndCup').value);
  var process=document.getElementById('headProcess').value;
  var mode=document.getElementById('headMode').value;
  if(!start||!end||start>end){showToast('ì˜¬ë°”ë¥¸ ì»µ ë²”ìœ„ë¥¼ ì…ë ¥í•˜ì„¸ìš”',true);return}
  if(!process){showToast('í”„ë¡œì„¸ìŠ¤ë¥¼ ì„ íƒí•˜ì„¸ìš”',true);return}
  initEvaluation(start,end,mode,process);
}

function startEvalByJudge(){
  var start=parseInt(document.getElementById('judgeStartCup').value);
  var end=parseInt(document.getElementById('judgeEndCup').value);
  var process=document.getElementById('judgeProcess').value;
  var mode=document.getElementById('judgeMode').value;
  if(!start||!end||start>end){showToast('ì˜¬ë°”ë¥¸ ì»µ ë²”ìœ„ë¥¼ ì…ë ¥í•˜ì„¸ìš”',true);return}
  if(!process){showToast('í”„ë¡œì„¸ìŠ¤ë¥¼ ì„ íƒí•˜ì„¸ìš”',true);return}
  initEvaluation(start,end,mode,process);
}

function initEvaluation(startCup,endCup,mode,process){
  evalData.startCup=startCup;
  evalData.endCup=endCup;
  evalData.mode=mode;
  evalData.process=process;
  evalData.cups=[];
  evalData.currentCupIndex=0;
  evalData.currentAttr='flavor';
  for(var i=startCup;i<=endCup;i++){
    evalData.cups.push({
      cupNumber:i,
      flavor:3.0,flavorIntensity:4,noteFlavor:'',flavorLocked:false,
      aftertaste:3.0,aftertastePersistence:4,noteAftertaste:'',aftertasteLocked:false,
      acidity:3.0,acidityIntensity:4,noteAcidity:'',acidityLocked:false,
      body:3.0,bodyIntensity:4,noteBody:'',bodyLocked:false,
      sweetness:3.0,sweetnessIntensity:4,noteSweetness:'',sweetnessLocked:false,
      overall:3.0,noteOverall:'',overallLocked:false,
      selectedTags:{flavor:[],aftertaste:[],acidity:[],body:[],sweetness:[],overall:[]},
      lastAttr:'flavor'
    });
  }
  renderCupNavigation();
  renderAttrCard();
  updateTotalScore();
  document.getElementById('evalContainer').classList.add('active');
  saveEvalState();
  startAutoSave();
}

function saveEvalState(){
  if(currentUser)localStorage.setItem('kcr_eval_'+currentUser.userID,JSON.stringify(evalData));
}

function renderCupNavigation(){
  var navHtml='';
  evalData.cups.forEach(function(cup,index){
    var total=cup.flavor+cup.aftertaste+cup.acidity+cup.body+(cup.sweetness*2)+cup.overall;
    var isActive=index===evalData.currentCupIndex?'active':'';
    navHtml+='<div class="cup-nav-btn '+isActive+'" onclick="switchCup('+index+')">';
    navHtml+='<div class="cup-nav-num">Cup '+cup.cupNumber+'</div>';
    navHtml+='<div class="cup-nav-score">'+total.toFixed(1)+'ì </div></div>';
  });
  document.getElementById('cupNavigation').innerHTML=navHtml;
  document.getElementById('currentCupNum').textContent='Cup '+evalData.cups[evalData.currentCupIndex].cupNumber;
}

function switchCup(index){
  saveCurrent();
  evalData.cups[evalData.currentCupIndex].lastAttr=evalData.currentAttr;
  evalData.currentCupIndex=index;
  evalData.currentAttr=evalData.cups[index].lastAttr||'flavor';
  document.querySelectorAll('.verification-result').forEach(function(el){el.classList.remove('active')});
  renderCupNavigation();
  renderAttrCard();
  updateTotalScore();
  saveEvalState();
}

function toggleScoreLock(attr){
  var cup=evalData.cups[evalData.currentCupIndex];
  var lockKey=attr+'Locked';
  cup[lockKey]=!cup[lockKey];
  renderAttrCard();
  saveEvalState();
  showToast(cup[lockKey]?'ì ìˆ˜ ì ê¸ˆ':'ì ìˆ˜ ì ê¸ˆ í•´ì œ');
}

function renderAttrCard(){
  var cup=evalData.cups[evalData.currentCupIndex];
  var attr=evalData.currentAttr;
  var tabs=document.querySelectorAll('.attr-tab');
  tabs.forEach(function(tab){
    var tabAttr=tab.getAttribute('data-attr');
    if(tabAttr===attr){tab.classList.add('active')}
    else{tab.classList.remove('active')}
    var noteKey='note'+tabAttr.charAt(0).toUpperCase()+tabAttr.slice(1);
    if(cup[noteKey]&&cup[noteKey].length>=10){tab.classList.add('filled')}
    else{tab.classList.remove('filled')}
  });
  
  var lockKey=attr+'Locked';
  var isLocked=cup[lockKey]||false;
  var intensityKey=(attr==='aftertaste')?'aftertastePersistence':attr+'Intensity';
  var noteKey='note'+attr.charAt(0).toUpperCase()+attr.slice(1);
  var html='<div class="attr-card"><h3 style="text-align:center;margin-bottom:24px">'+attr.toUpperCase()+'</h3>';
  html+='<div class="score-display" id="scoreDisplay">'+cup[attr].toFixed(2)+'</div>';
  html+='<div class="score-meaning" id="scoreMeaning">('+getScoreMeaning(cup[attr])+')</div>';
  if(attr==='sweetness'){
    html+='<div class="sweetness-multiplier" id="sweetnessMultiplier">x2 = '+(cup[attr]*2).toFixed(2)+'ì </div>';
  }
  html+='<input type="range" class="score-slider" id="scoreSlider" min="0" max="5" step="0.25" value="'+cup[attr]+'" oninput="updateScore(this.value)" '+(isLocked?'disabled':'')+' >';
  html+='<div class="score-labels"><span>0</span><span>1</span><span>2</span><span>3</span><span>4</span><span>5</span></div>';
  html+='<div class="score-lock">';
  html+='<input type="checkbox" id="lockCheckbox" '+(isLocked?'checked':'')+' onchange="toggleScoreLock(\''+attr+'\')">';
  html+='<label for="lockCheckbox">ì ìˆ˜ í™•ì • (ìŠ¬ë¼ì´ë” ì ê¸ˆ)</label></div>';
  
  if(attr!=='overall'){
    var intensityLabel=(attr==='aftertaste')?'ì§€ì†ì„±':'ê°•ë„';
    html+='<div class="intensity-label">'+intensityLabel+' (ì ìˆ˜ ì•„ë‹˜)</div><div class="intensity-grid">';
    for(var key in INTENSITY_LEVELS){
      var level=INTENSITY_LEVELS[key];
      var selected=(cup[intensityKey]===level.value)?'selected':'';
      html+='<div class="intensity-btn '+selected+'" onclick="updateIntensity('+level.value+')">';
      html+='<div>'+level.label+'</div><div style="font-size:13px;margin-top:4px;opacity:0.7">('+level.value+')</div></div>';
    }
    html+='</div>';
  }
  if(SMART_TAGS[attr]&&attr!=='overall'){
    html+='<div class="smart-tags-section"><div class="smart-tags-title">Smart Tags</div>';
    html+='<div class="smart-tags-hint">íŠ¹ì„± ì„ íƒ (ìµœëŒ€ '+MAX_TAGS+'ê°œ)</div>';
    html+='<div class="selected-tags" id="selectedTags_'+attr+'">';
    if(cup.selectedTags[attr]&&cup.selectedTags[attr].length>0){
      cup.selectedTags[attr].forEach(function(tag){
        html+='<span class="selected-tag" onclick="removeTag(\''+attr+'\',\''+tag+'\')">'+tag+' Ã—</span>';
      });
    }
    html+='</div>';
    
    if(attr==='flavor'||attr==='aftertaste'||attr==='acidity'||attr==='sweetness'){
      html+='<div class="category-primary" id="categoryPrimary_'+attr+'">';
      for(var primary in SMART_TAGS[attr]){
        html+='<div class="category-btn-primary" onclick="togglePrimary(\''+attr+'\',\''+primary+'\')">'+primary+'</div>';
      }
      html+='</div>';
      for(var primary in SMART_TAGS[attr]){
        var secondaryObj=SMART_TAGS[attr][primary];
        html+='<div class="category-secondary" id="secondary_'+attr+'_'+primary+'">';
        for(var secondary in secondaryObj){
          html+='<div class="category-btn-secondary" onclick="toggleSecondary(\''+attr+'\',\''+primary+'\',\''+secondary+'\')">'+secondary+'</div>';
        }
        html+='</div>';
        for(var secondary in secondaryObj){
          var tertiaryArr=secondaryObj[secondary];
          html+='<div class="category-tertiary" id="tertiary_'+attr+'_'+primary+'_'+secondary+'">';
          tertiaryArr.forEach(function(tag){
            var isSelected=cup.selectedTags[attr]&&cup.selectedTags[attr].indexOf(tag)>-1;
            var isConflict=checkTagConflict(attr,tag,cup.selectedTags[attr]);
            var conflictClass=isConflict?' conflict':'';
            html+='<div class="category-btn-tertiary'+(isSelected?' selected':'')+conflictClass+'" onclick="selectTag(\''+attr+'\',\''+tag+'\')">'+tag+'</div>';
          });
          html+='</div>';
        }
      }
    }else{
      html+='<div style="display:flex;flex-wrap:wrap;gap:6px;margin:12px 0">';
      for(var category in SMART_TAGS[attr]){
        var tags=SMART_TAGS[attr][category];
        tags.forEach(function(tag){
          var isSelected=cup.selectedTags[attr]&&cup.selectedTags[attr].indexOf(tag)>-1;
          var isConflict=checkTagConflict(attr,tag,cup.selectedTags[attr]);
          var conflictClass=isConflict?' conflict':'';
          html+='<div class="category-btn-secondary'+(isSelected?' selected':'')+conflictClass+'" onclick="selectTag(\''+attr+'\',\''+tag+'\')">'+tag+'</div>';
        });
      }
      html+='</div>';
    }
    html+='<button class="btn-assistant" onclick="generateComments(\''+attr+'\')">ì½”ë©˜íŠ¸ ìƒì„±</button>';
    html+='<div class="generated-comments-area" id="generatedComments_'+attr+'">';
    html+='<div style="font-size:12px;color:#999;margin-bottom:8px">ìƒì„±ëœ ì½”ë©˜íŠ¸ (í´ë¦­í•˜ì—¬ ì‚¬ìš©)</div>';
    html+='<div id="commentVariations_'+attr+'"></div></div></div>';
  }
  html+='<label class="comment-label">ìµœì¢… ì½”ë©˜íŠ¸ (ìµœì†Œ 10ì)</label>';
  html+='<textarea id="commentInput" placeholder="Smart Tagsë¡œ ìƒì„± í›„ ìˆ˜ì •í•˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥" oninput="updateComment(this.value)">';
  html+=cup[noteKey]+'</textarea>';
  if(attr!=='overall'){
    html+='<button class="btn-assistant" onclick="checkComment(\''+attr+'\')">ì½”ë©˜íŠ¸ ê²€ì¦</button>';
    html+='<div class="verification-result" id="verification_'+attr+'">';
    html+='<div class="verification-issue" id="verificationIssue_'+attr+'"></div>';
    html+='<div class="verification-suggestion" id="verificationSuggestion_'+attr+'"></div></div>';
  }
  html+='</div>';
  document.getElementById('attrCardArea').innerHTML=html;
}

function checkTagConflict(attr,newTag,currentTags){
  if(!ATTRIBUTE_CONFLICTS[attr])return false;
  if(!ATTRIBUTE_CONFLICTS[attr][newTag])return false;
  
  var conflicts=ATTRIBUTE_CONFLICTS[attr][newTag];
  for(var i=0;i<currentTags.length;i++){
    if(conflicts.indexOf(currentTags[i])>-1){
      return true;
    }
  }
  return false;
}

function togglePrimary(attrKey,primary){
  var secondaryId='secondary_'+attrKey+'_'+primary;
  var secondaryDiv=document.getElementById(secondaryId);
  if(!secondaryDiv)return;
  var allSecondary=document.querySelectorAll('[id^="secondary_'+attrKey+'_"]');
  allSecondary.forEach(function(div){if(div.id!==secondaryId)div.classList.remove('active')});
  var allTertiary=document.querySelectorAll('[id^="tertiary_'+attrKey+'_"]');
  allTertiary.forEach(function(div){div.classList.remove('active')});
  secondaryDiv.classList.toggle('active');
  var cup=evalData.cups[evalData.currentCupIndex];
  var index=cup.selectedTags[attrKey].indexOf(primary);
  if(index>-1){cup.selectedTags[attrKey].splice(index,1);updateSelectedTagsDisplay(attrKey)}
  else{if(cup.selectedTags[attrKey].length<MAX_TAGS){cup.selectedTags[attrKey].push(primary);updateSelectedTagsDisplay(attrKey)}}
}

function toggleSecondary(attrKey,primary,secondary){
  var tertiaryId='tertiary_'+attrKey+'_'+primary+'_'+secondary;
  var tertiaryDiv=document.getElementById(tertiaryId);
  if(!tertiaryDiv)return;
  var allTertiary=document.querySelectorAll('[id^="tertiary_'+attrKey+'_"]');
  allTertiary.forEach(function(div){if(div.id!==tertiaryId)div.classList.remove('active')});
  tertiaryDiv.classList.toggle('active');
  var cup=evalData.cups[evalData.currentCupIndex];
  var primaryIndex=cup.selectedTags[attrKey].indexOf(primary);
  if(primaryIndex>-1)cup.selectedTags[attrKey].splice(primaryIndex,1);
  var index=cup.selectedTags[attrKey].indexOf(secondary);
  if(index>-1){cup.selectedTags[attrKey].splice(index,1);updateSelectedTagsDisplay(attrKey)}
  else{if(cup.selectedTags[attrKey].length<MAX_TAGS){cup.selectedTags[attrKey].push(secondary);updateSelectedTagsDisplay(attrKey)}}
}

function saveCurrent(){
  var cup=evalData.cups[evalData.currentCupIndex];
  var attr=evalData.currentAttr;
  var noteKey='note'+attr.charAt(0).toUpperCase()+attr.slice(1);
  var commentInput=document.getElementById('commentInput');
  if(commentInput)cup[noteKey]=commentInput.value;
  saveEvalState();
}

function updateScore(val){
  var cup=evalData.cups[evalData.currentCupIndex];
  var attr=evalData.currentAttr;
  cup[attr]=parseFloat(val);
  document.getElementById('scoreDisplay').textContent=parseFloat(val).toFixed(2);
  document.getElementById('scoreMeaning').textContent='('+getScoreMeaning(parseFloat(val))+')';
  if(attr==='sweetness'){
    var sweetMulti=document.getElementById('sweetnessMultiplier');
    if(sweetMulti)sweetMulti.textContent='x2 = '+(parseFloat(val)*2).toFixed(2)+'ì ';
  }
  updateTotalScore();
  saveEvalState();
}

function updateIntensity(val){
  var cup=evalData.cups[evalData.currentCupIndex];
  var attr=evalData.currentAttr;
  var intensityKey=(attr==='aftertaste')?'aftertastePersistence':attr+'Intensity';
  cup[intensityKey]=val;
  renderAttrCard();
  saveEvalState();
}

function updateComment(val){
  var cup=evalData.cups[evalData.currentCupIndex];
  var attr=evalData.currentAttr;
  var noteKey='note'+attr.charAt(0).toUpperCase()+attr.slice(1);
  cup[noteKey]=val;
  saveEvalState();
}

function updateTotalScore(){
  var cup=evalData.cups[evalData.currentCupIndex];
  var total=cup.flavor+cup.aftertaste+cup.acidity+cup.body+(cup.sweetness*2)+cup.overall;
  document.getElementById('evalTotalScore').textContent=total.toFixed(2);
  renderCupNavigation();
}

document.addEventListener('click',function(e){
  if(e.target.classList.contains('attr-tab')){
    saveCurrent();
    evalData.currentAttr=e.target.getAttribute('data-attr');
    evalData.cups[evalData.currentCupIndex].lastAttr=evalData.currentAttr;
    renderAttrCard();
    saveEvalState();
  }
});

function selectTag(attrKey,tag){
  var cup=evalData.cups[evalData.currentCupIndex];
  if(!cup.selectedTags[attrKey])cup.selectedTags[attrKey]=[];
  
  if(checkTagConflict(attrKey,tag,cup.selectedTags[attrKey])){
    var conflicts=ATTRIBUTE_CONFLICTS[attrKey][tag];
    var conflictList=conflicts.join(', ');
    showToast('ì¶©ëŒ: "'+tag+'"ëŠ” ë‹¤ìŒê³¼ ëª¨ìˆœë©ë‹ˆë‹¤: '+conflictList,true);
    return;
  }
  
  var index=cup.selectedTags[attrKey].indexOf(tag);
  if(index>-1){cup.selectedTags[attrKey].splice(index,1);showToast('íƒœê·¸ ì‚­ì œ: '+tag)}
  else{if(cup.selectedTags[attrKey].length>=MAX_TAGS){showToast('ìµœëŒ€ '+MAX_TAGS+'ê°œê¹Œì§€ ì„ íƒ ê°€ëŠ¥',true);return}cup.selectedTags[attrKey].push(tag);showToast('íƒœê·¸ ì¶”ê°€: '+tag)}
  updateSelectedTagsDisplay(attrKey);
  saveEvalState();
}

function removeTag(attrKey,tag){
  var cup=evalData.cups[evalData.currentCupIndex];
  var index=cup.selectedTags[attrKey].indexOf(tag);
  if(index>-1){cup.selectedTags[attrKey].splice(index,1);updateSelectedTagsDisplay(attrKey);showToast('íƒœê·¸ ì‚­ì œ: '+tag);saveEvalState()}
}

function updateSelectedTagsDisplay(attrKey){
  var cup=evalData.cups[evalData.currentCupIndex];
  var container=document.getElementById('selectedTags_'+attrKey);
  if(!container)return;
  var html='';
  if(cup.selectedTags[attrKey]&&cup.selectedTags[attrKey].length>0){
    cup.selectedTags[attrKey].forEach(function(tag){
      html+='<span class="selected-tag" onclick="removeTag(\''+attrKey+'\',\''+tag+'\')">'+tag+' Ã—</span>';
    });
  }
  container.innerHTML=html;
  
  var allTertiaryBtns=document.querySelectorAll('[id^="tertiary_"] .category-btn-tertiary');
  allTertiaryBtns.forEach(function(btn){
    var btnText=btn.innerText;
    btn.classList.remove('selected','conflict');
    if(cup.selectedTags[attrKey]&&cup.selectedTags[attrKey].indexOf(btnText)>-1){
      btn.classList.add('selected');
    }else if(checkTagConflict(attrKey,btnText,cup.selectedTags[attrKey])){
      btn.classList.add('conflict');
    }
  });
  
  var allSecondaryBtns=document.querySelectorAll('.category-btn-secondary');
  allSecondaryBtns.forEach(function(btn){
    var btnText=btn.innerText;
    btn.classList.remove('selected','conflict');
    if(cup.selectedTags[attrKey]&&cup.selectedTags[attrKey].indexOf(btnText)>-1){
      btn.classList.add('selected');
    }else if(checkTagConflict(attrKey,btnText,cup.selectedTags[attrKey])){
      btn.classList.add('conflict');
    }
  });
}

// ===== v3.0: ê³„ì¸µ êµ¬ì¡° ì¤‘ë³µ ì œê±° ì ìš© =====
function generateComments(attrKey){
  var cup=evalData.cups[evalData.currentCupIndex];
  var score=cup[attrKey];
  var intensityKey='';
  if(attrKey==='flavor')intensityKey='flavorIntensity';
  else if(attrKey==='aftertaste')intensityKey='aftertastePersistence';
  else if(attrKey==='acidity')intensityKey='acidityIntensity';
  else if(attrKey==='body')intensityKey='bodyIntensity';
  else if(attrKey==='sweetness')intensityKey='sweetnessIntensity';
  var intensity=intensityKey?cup[intensityKey]:4;
  var tags=cup.selectedTags[attrKey]||[];
  if(tags.length===0){showToast('ë¨¼ì € íŠ¹ì„±ì„ ì„ íƒí•˜ì„¸ìš”',true);return}
  
  var filteredTags=filterHierarchicalTags(tags, attrKey);
  
  // í•„í„°ë§ í›„ íƒœê·¸ê°€ ì—†ìœ¼ë©´ ì›ë³¸ íƒœê·¸ ì‚¬ìš©
  if(filteredTags.length===0){
    filteredTags=tags.slice(0, MAX_TAGS);
  } else {
    // ìµœëŒ€ MAX_TAGS(5)ê°œê¹Œì§€ë§Œ ì‚¬ìš©
    filteredTags=filteredTags.slice(0, MAX_TAGS);
  }
  
  // ===== ì ìˆ˜ì™€ ê°•ë„ë¥¼ êµì°¨ ê²€ì¦í•˜ì—¬ ì ì ˆí•œ í‘œí˜„ ì„ íƒ =====
  var intensityExpression='';
  
  // ë‚®ì€ ì ìˆ˜ (0-2.99): ë¶€ì •ì /ì•½í•œ í‘œí˜„ë§Œ ì‚¬ìš©
  if(score < 3.0) {
    if(intensity<=2) intensityExpression='ë¯¸ì•½í•œ';
    else if(intensity===3) intensityExpression='ì•½ê°„ ì¡´ì¬í•˜ëŠ”';
    else if(intensity===4) intensityExpression='ì¡´ì¬í•˜ëŠ”';
    else if(intensity===5) intensityExpression='ê°ì§€ë˜ëŠ”';
    else if(intensity===6) intensityExpression='ì¸ì§€ë˜ëŠ”';
    else intensityExpression='ë‘ë“œëŸ¬ì§€ëŠ”';
  }
  // ë³´í†µ ì ìˆ˜ (3.0-3.99): ì¤‘ë¦½ì  í‘œí˜„
  else if(score < 4.0) {
    if(intensity<=2) intensityExpression='ì•½í•œ';
    else if(intensity===3) intensityExpression='ë‹¤ì†Œ ì•½í•œ';
    else if(intensity===4) intensityExpression='ì¤‘ê°„ ì •ë„ì˜';
    else if(intensity===5) intensityExpression='ì ì ˆí•œ';
    else if(intensity===6) intensityExpression='ì¶©ë¶„í•œ';
    else intensityExpression='ê°•í•œ';
  }
  // ë†’ì€ ì ìˆ˜ (4.0+): ê¸ì •ì  í‘œí˜„ ì‚¬ìš©
  else {
    if(intensity<=2) intensityExpression='ì€ì€í•œ';
    else if(intensity===3) intensityExpression='ë¶€ë“œëŸ¬ìš´';
    else if(intensity===4) intensityExpression='ê· í˜•ì¡íŒ';
    else if(intensity===5) intensityExpression='ëšœë ·í•œ';
    else if(intensity===6) intensityExpression='ê°•í•œ';
    else intensityExpression='ë§¤ìš° ê°•í•œ';
  }
  
  var qualityExpression='',connectWord='',endingPhrase='';
  if(score>=4.75){qualityExpression='ë§¤ìš° ìš°ìˆ˜í•˜ë©°';connectWord='í‘œí˜„ë˜ì–´';endingPhrase='í›Œë¥­í•œ í’ˆì§ˆì…ë‹ˆë‹¤'}
  else if(score>=4.0){qualityExpression='ì¢‹ì€ ìˆ˜ì¤€ì´ë©°';connectWord='ë‚˜íƒ€ë‚˜';endingPhrase='ì¢‹ì€ í’ˆì§ˆì…ë‹ˆë‹¤'}
  else if(score>=3.25){qualityExpression='ì ì ˆí•˜ë‚˜';connectWord='ê°ì§€ë˜ë©°';endingPhrase='ë³´í†µ ìˆ˜ì¤€ì…ë‹ˆë‹¤'}
  else if(score>=3.0){qualityExpression='ë³´í†µì´ë©°';connectWord='ìˆìœ¼ë‚˜';endingPhrase='í‰ë²”í•œ ìˆ˜ì¤€ì…ë‹ˆë‹¤'}
  else if(score>=2.25){qualityExpression='ë¶€ì¡±í•˜ë©°';connectWord='ê°ì§€ë˜ë‚˜';endingPhrase='ë¯¸í¡í•œ í’ˆì§ˆì…ë‹ˆë‹¤'}
  else if(score>=1.5){qualityExpression='ë‚®ìœ¼ë©°';connectWord='ë¶ˆë¶„ëª…í•˜ì—¬';endingPhrase='ë¶€ì •ì  í’ˆì§ˆì…ë‹ˆë‹¤'}
  else{qualityExpression='ë§¤ìš° ë‚®ìœ¼ë©°';connectWord='ê±°ì˜ ì—†ì–´';endingPhrase='ë§¤ìš° ë¶€ì •ì ì…ë‹ˆë‹¤'}
  
  var tagList=filteredTags.join(', ');
  
  // tagListê°€ ë¹„ì–´ìˆìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©
  if(!tagList||tagList.trim()===''){
    tagList='íŠ¹ì„±';
  }
  var variations=[];
  
  // ===== FLAVOR =====
  if(attrKey==='flavor'){
    if(score>=4.0){
      // ê¸ì •ì  í‘œí˜„
      variations.push(tagList+' í–¥ë¯¸ê°€ '+intensityExpression+' ê°•ë„ë¡œ í‘œí˜„ë˜ì–´ ë³µí•©ì ì¸ í”Œë ˆì´ë²„ê°€ '+endingPhrase+'.');
      variations.push(intensityExpression+' ê°•ë„ì˜ '+tagList+' ë…¸íŠ¸ê°€ ì¡°í™”ë¡­ê²Œ ë‚˜íƒ€ë‚˜ë©° '+endingPhrase+'.');
    }else if(score>=3.0){
      // ì¤‘ë¦½ì  í‘œí˜„
      variations.push(tagList+' í–¥ë¯¸ê°€ '+intensityExpression+' ê°•ë„ë¡œ ê°ì§€ë˜ë©° '+endingPhrase+'.');
      variations.push(intensityExpression+' ê°•ë„ì˜ '+tagList+' ë…¸íŠ¸ê°€ ìˆìœ¼ë‚˜ '+endingPhrase+'.');
    }else{
      // ë¶€ì •ì  í‘œí˜„ (2.99 ì´í•˜)
      variations.push(tagList+' í–¥ë¯¸ê°€ '+intensityExpression+' ê°•ë„ì´ë‚˜ ë¶ˆë¶„ëª…í•˜ë©° '+endingPhrase+'.');
      variations.push(intensityExpression+' ê°•ë„ì˜ '+tagList+' ë…¸íŠ¸ê°€ ë¶€ì¡±í•˜ê³  '+endingPhrase+'.');
    }
  }
  
  // ===== AFTERTASTE =====
  else if(attrKey==='aftertaste'){
    // ì§€ì†ì„± í‘œí˜„ë„ ì ìˆ˜ì— ë”°ë¼ ì¡°ì •
    var persistenceWord='';
    if(score>=4.0){
      persistenceWord=(intensity<=2)?'ì§§ìœ¼ë‚˜ ê¹”ë”í•œ':((intensity<=4)?'ì ì ˆí•œ':'ê¸´');
    }else if(score>=3.0){
      persistenceWord=(intensity<=2)?'ì§§ì€':((intensity<=4)?'ì¤‘ê°„':'ë‹¤ì†Œ ê¸´');
    }else{
      persistenceWord=(intensity<=2)?'ë§¤ìš° ì§§ì€':((intensity<=4)?'ë¶€ì¡±í•œ':'ì¡´ì¬í•˜ëŠ”');
    }
    
    if(score>=4.0){
      // ê¸ì •ì  í‘œí˜„
      variations.push(tagList+' ì—¬ìš´ì´ '+persistenceWord+' ì§€ì†ì„±ìœ¼ë¡œ ì¸ìƒì ìœ¼ë¡œ ë‚¨ì•„ '+endingPhrase+'.');
      variations.push(persistenceWord+' ì§€ì†ì„±ì˜ '+tagList+' í”¼ë‹ˆì‹œê°€ í’ë¶€í•˜ê²Œ ì´ì–´ì ¸ '+endingPhrase+'.');
    }else if(score>=3.0){
      // ì¤‘ë¦½ì  í‘œí˜„
      variations.push(tagList+' ì—¬ìš´ì´ '+persistenceWord+' ì§€ì†ì„±ìœ¼ë¡œ ê°ì§€ë˜ë©° '+endingPhrase+'.');
      variations.push(persistenceWord+' ì§€ì†ì„±ì˜ '+tagList+' í”¼ë‹ˆì‹œê°€ ìˆìœ¼ë‚˜ '+endingPhrase+'.');
    }else{
      // ë¶€ì •ì  í‘œí˜„
      variations.push(tagList+' ì—¬ìš´ì´ '+persistenceWord+' ì§€ì†ì„±ìœ¼ë¡œ ì•„ì‰¬ìš°ë©° '+endingPhrase+'.');
      variations.push(persistenceWord+' ì§€ì†ì„±ì˜ '+tagList+' í”¼ë‹ˆì‹œê°€ ë¶ˆì¶©ë¶„í•˜ê³  '+endingPhrase+'.');
    }
  }
  
  // ===== ACIDITY =====
  else if(attrKey==='acidity'){
    if(score>=4.0){
      // ê¸ì •ì  í‘œí˜„
      variations.push(tagList+' ì‚°ë¯¸ê°€ '+intensityExpression+' ê°•ë„ë¡œ ìƒë™ê° ìˆê²Œ ëŠê»´ì§€ë©° '+endingPhrase+'.');
      variations.push(intensityExpression+' ê°•ë„ì˜ '+tagList+' ì• ì‹œë””í‹°ê°€ ê¹”ë”í•˜ê³  '+endingPhrase+'.');
    }else if(score>=3.0){
      // ì¤‘ë¦½ì  í‘œí˜„
      variations.push(tagList+' ì‚°ë¯¸ê°€ '+intensityExpression+' ê°•ë„ë¡œ ê°ì§€ë˜ë©° '+endingPhrase+'.');
      variations.push(intensityExpression+' ê°•ë„ì˜ '+tagList+' ì• ì‹œë””í‹°ê°€ ìˆìœ¼ë‚˜ '+endingPhrase+'.');
    }else{
      // ë¶€ì •ì  í‘œí˜„
      variations.push(tagList+' ì‚°ë¯¸ê°€ '+intensityExpression+' ê°•ë„ì´ë‚˜ ë¶ˆê· í˜•í•˜ë©° '+endingPhrase+'.');
      variations.push(intensityExpression+' ê°•ë„ì˜ '+tagList+' ì• ì‹œë””í‹°ê°€ ë¶€ì¡±í•˜ê³  '+endingPhrase+'.');
    }
  }
  
  // ===== BODY =====
  else if(attrKey==='body'){
    if(score>=4.0){
      // ê¸ì •ì  í‘œí˜„
      variations.push(intensityExpression+' ê°•ë„ì˜ '+tagList+' ë°”ë””ê°ì´ ê· í˜• ìˆê³  '+endingPhrase+'.');
      variations.push(tagList+' ì§ˆê°ì´ '+intensityExpression+' ê°•ë„ë¡œ ëŠê»´ì§€ë©° ì¢‹ì€ ë§ˆìš°ìŠ¤í•„ë¡œ '+endingPhrase+'.');
    }else if(score>=3.0){
      // ì¤‘ë¦½ì  í‘œí˜„
      variations.push(intensityExpression+' ê°•ë„ì˜ '+tagList+' ë°”ë””ê°ì´ ê°ì§€ë˜ë©° '+endingPhrase+'.');
      variations.push(tagList+' ì§ˆê°ì´ '+intensityExpression+' ê°•ë„ë¡œ ìˆìœ¼ë‚˜ '+endingPhrase+'.');
    }else{
      // ë¶€ì •ì  í‘œí˜„
      variations.push(intensityExpression+' ê°•ë„ì˜ '+tagList+' ë°”ë””ê°ì´ ë¶ˆê· í˜•í•˜ë©° '+endingPhrase+'.');
      variations.push(tagList+' ì§ˆê°ì´ '+intensityExpression+' ê°•ë„ì´ë‚˜ ì•„ì‰½ê³  '+endingPhrase+'.');
    }
  }
  
  // ===== SWEETNESS =====
  else if(attrKey==='sweetness'){
    if(score>=4.0){
      // ê¸ì •ì  í‘œí˜„
      variations.push(tagList+' ë‹¨ë§›ì´ '+intensityExpression+' ê°•ë„ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ í‘œí˜„ë˜ì–´ '+endingPhrase+'.');
      variations.push(intensityExpression+' ê°•ë„ì˜ '+tagList+' ìŠ¤ìœ„íŠ¸ë‹ˆìŠ¤ê°€ ê¹”ë”í•˜ë©° '+endingPhrase+'.');
    }else if(score>=3.0){
      // ì¤‘ë¦½ì  í‘œí˜„
      variations.push(tagList+' ë‹¨ë§›ì´ '+intensityExpression+' ê°•ë„ë¡œ ê°ì§€ë˜ë©° '+endingPhrase+'.');
      variations.push(intensityExpression+' ê°•ë„ì˜ '+tagList+' ìŠ¤ìœ„íŠ¸ë‹ˆìŠ¤ê°€ ìˆìœ¼ë‚˜ '+endingPhrase+'.');
    }else{
      // ë¶€ì •ì  í‘œí˜„
      variations.push(tagList+' ë‹¨ë§›ì´ '+intensityExpression+' ê°•ë„ì´ë‚˜ ë¶ˆê· í˜•í•˜ë©° '+endingPhrase+'.');
      variations.push(intensityExpression+' ê°•ë„ì˜ '+tagList+' ìŠ¤ìœ„íŠ¸ë‹ˆìŠ¤ê°€ ë¶€ì¡±í•˜ê³  '+endingPhrase+'.');
    }
  }
  
  var container=document.getElementById('commentVariations_'+attrKey);
  if(container){
    var html='';
    variations.forEach(function(comment){
      html+='<div class="comment-variation" onclick="useGeneratedComment(\''+attrKey+'\',`'+comment+'`)">'+comment+'</div>';
    });
    container.innerHTML=html;
  }
  var commentsArea=document.getElementById('generatedComments_'+attrKey);
  if(commentsArea)commentsArea.classList.add('active');
}

function useGeneratedComment(attrKey,comment){
  var input=document.getElementById('commentInput');
  if(input){input.value=comment;updateComment(comment);showToast('ì½”ë©˜íŠ¸ ì ìš©ë¨')}
}

function checkComment(attrKey){
  var cup=evalData.cups[evalData.currentCupIndex];
  var score=cup[attrKey];
  var intensityKey='';
  if(attrKey==='flavor')intensityKey='flavorIntensity';
  else if(attrKey==='aftertaste')intensityKey='aftertastePersistence';
  else if(attrKey==='acidity')intensityKey='acidityIntensity';
  else if(attrKey==='body')intensityKey='bodyIntensity';
  else if(attrKey==='sweetness')intensityKey='sweetnessIntensity';
  var intensity=intensityKey?cup[intensityKey]:4;
  var noteKey='note'+attrKey.charAt(0).toUpperCase()+attrKey.slice(1);
  var comment=cup[noteKey]||'';
  var selectedTags=cup.selectedTags[attrKey]||[];
  
  showOverlay();
  google.script.run
    .withSuccessHandler(function(result){
      hideOverlay();
      var verifyDiv=document.getElementById('verification_'+attrKey);
      var issueDiv=document.getElementById('verificationIssue_'+attrKey);
      var suggDiv=document.getElementById('verificationSuggestion_'+attrKey);
      if(!verifyDiv||!issueDiv||!suggDiv)return;
      verifyDiv.className='verification-result active '+result.severity;
      if(result.hasIssue){issueDiv.textContent=result.issue;suggDiv.textContent=result.suggestion}
      else{issueDiv.textContent='ê²€ì¦ í†µê³¼';suggDiv.textContent=result.suggestion}
    })
    .withFailureHandler(function(err){hideOverlay();showToast('ê²€ì¦ ì˜¤ë¥˜: '+err,true)})
    .checkCommentLogic(attrKey,score,intensity,comment,selectedTags);
}

function handleSubmitClick(){
  if(submitDebounceTimer){
    showToast('ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...',true);
    return;
  }
  submitDebounceTimer=setTimeout(function(){
    submitDebounceTimer=null;
  },3000);
  
  submitAllEvaluations();
}

function submitAllEvaluations(){
  if(isSubmitting){showToast('ì œì¶œ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤...');return}
  saveCurrent();
  var missingComments=[];
  evalData.cups.forEach(function(cup){
    ['Flavor','Aftertaste','Acidity','Body','Sweetness','Overall'].forEach(function(attr){
      var noteKey='note'+attr;
      if(!cup[noteKey]||cup[noteKey].length<10)missingComments.push('Cup '+cup.cupNumber+' - '+attr);
    });
  });
  
  if(missingComments.length>0){
    var warningMsg='ë‹¤ìŒ í•­ëª©ì˜ ì½”ë©˜íŠ¸ê°€ 10ì ë¯¸ë§Œì…ë‹ˆë‹¤:\n\n';
    warningMsg+=missingComments.join('\n');
    warningMsg+='\n\nê·¸ë˜ë„ ì œì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?';
    if(!confirm(warningMsg))return;
  }
  
  if(!confirm('ì´ '+evalData.cups.length+'ê°œ ì»µì„ ì œì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;
  
  isSubmitting=true;
  var submitBtn=document.getElementById('submitNavBtn');
  submitBtn.disabled=true;
  submitBtn.textContent='ì œì¶œ ì¤‘...';
  showOverlay();
  var payload={judgeId:currentUser.userID,judgeName:currentUser.name,team:currentUser.team,mode:evalData.mode,process:evalData.process,cups:evalData.cups};
  
  google.script.run
    .withSuccessHandler(function(res){
      hideOverlay();
      isSubmitting=false;
      submitBtn.disabled=false;
      submitBtn.textContent='ì œì¶œì™„ë£Œ';
      if(res.success){
        if(currentUser)localStorage.removeItem('kcr_eval_'+currentUser.userID);
        showToast('ì œì¶œ ì™„ë£Œ!');
        exitEvaluation();
      }else{showToast(res.message||'ì œì¶œ ì‹¤íŒ¨',true)}
    })
    .withFailureHandler(function(err){
      hideOverlay();
      isSubmitting=false;
      submitBtn.disabled=false;
      submitBtn.textContent='ì œì¶œì™„ë£Œ';
      showToast('ì œì¶œ ì˜¤ë¥˜: '+err,true);
    })
    .batchSubmitEvaluations(payload);
}

function exitEvaluation(){
  stopAutoSave();
  if(currentUser)localStorage.removeItem('kcr_eval_'+currentUser.userID);
  document.getElementById('evalContainer').classList.remove('active');
  evalData={cups:[],currentCupIndex:0,currentAttr:'flavor',startCup:0,endCup:0,mode:''};
  if(currentUser.role==='admin'){showScreen('adminScreen')}
  else if(currentUser.role.indexOf('head')===0){showScreen('headScreen')}
  else{showScreen('judgeScreen')}
}

function loadCalibrationCups(){
  showOverlay();
  google.script.run
    .withSuccessHandler(function(cups){
      hideOverlay();
      if(!cups||cups.length===0){
        document.getElementById('calCupList').innerHTML='<p style="text-align:center;color:#999;padding:40px">Calibration ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        showScreen('calListScreen');
        return;
      }
      var html='';
      cups.forEach(function(c){
        html+='<div class="review-item" onclick="loadCalibrationResult('+c+')">';
        html+='<h3>Cup '+c+'</h3></div>';
      });
      document.getElementById('calCupList').innerHTML=html;
      showScreen('calListScreen');
    })
    .withFailureHandler(function(err){hideOverlay();showToast('ì˜¤ë¥˜: '+err,true)})
    .getCalibrationCupNumbers();
}

function loadCalibrationResult(cupNum){
  showOverlay();
  google.script.run
    .withSuccessHandler(function(results){
      hideOverlay();
      if(!results||results.length===0){showToast('í•´ë‹¹ ì»µì˜ í‰ê°€ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤',true);showScreen('calListScreen');return}
      
      var html='<h3 style="text-align:center;margin-bottom:24px">Cup '+cupNum+'</h3>';
      var judges=results;
      var totals=judges.map(function(j){return j.total});
      var avgTotal=totals.reduce(function(a,b){return a+b},0)/totals.length;
      var variance=totals.reduce(function(acc,val){return acc+Math.pow(val-avgTotal,2)},0)/totals.length;
      var stdDev=Math.sqrt(variance);
      var flavors=judges.map(function(j){return j.flavor});
      var aftertastes=judges.map(function(j){return j.aftertaste});
      var acidities=judges.map(function(j){return j.acidity});
      var bodies=judges.map(function(j){return j.body});
      var sweetnesses=judges.map(function(j){return j.sweetness*2});
      var overalls=judges.map(function(j){return j.overall});
      var calcStd=function(arr){var avg=arr.reduce(function(a,b){return a+b},0)/arr.length;var variance=arr.reduce(function(acc,val){return acc+Math.pow(val-avg,2)},0)/arr.length;return Math.sqrt(variance)};
      html+='<div class="cal-stats">';
      html+='<div class="cal-stats-title">í†µê³„ (í‰ê·  Â± í‘œì¤€í¸ì°¨)</div>';
      html+='<div class="cal-stats-row"><div>Total:</div><div>'+avgTotal.toFixed(2)+' Â± '+stdDev.toFixed(2)+'</div></div>';
      html+='<div class="cal-stats-row"><div>Flavor:</div><div>'+(flavors.reduce(function(a,b){return a+b},0)/flavors.length).toFixed(2)+' Â± '+calcStd(flavors).toFixed(2)+'</div></div>';
      html+='<div class="cal-stats-row"><div>Aftertaste:</div><div>'+(aftertastes.reduce(function(a,b){return a+b},0)/aftertastes.length).toFixed(2)+' Â± '+calcStd(aftertastes).toFixed(2)+'</div></div>';
      html+='<div class="cal-stats-row"><div>Acidity:</div><div>'+(acidities.reduce(function(a,b){return a+b},0)/acidities.length).toFixed(2)+' Â± '+calcStd(acidities).toFixed(2)+'</div></div>';
      html+='<div class="cal-stats-row"><div>Body:</div><div>'+(bodies.reduce(function(a,b){return a+b},0)/bodies.length).toFixed(2)+' Â± '+calcStd(bodies).toFixed(2)+'</div></div>';
      html+='<div class="cal-stats-row"><div>Sweetness:</div><div>'+(sweetnesses.reduce(function(a,b){return a+b},0)/sweetnesses.length).toFixed(2)+' Â± '+calcStd(sweetnesses).toFixed(2)+'</div></div>';
      html+='<div class="cal-stats-row"><div>Overall:</div><div>'+(overalls.reduce(function(a,b){return a+b},0)/overalls.length).toFixed(2)+' Â± '+calcStd(overalls).toFixed(2)+'</div></div>';
      html+='</div>';
      judges.forEach(function(j){
        html+='<div class="cal-judge-row">';
        html+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">';
        html+='<strong>'+j.judgeName+'</strong>';
        html+='<div style="font-size:24px;font-weight:700">'+j.total.toFixed(2)+'</div>';
        html+='</div>';
        html+='<div class="cal-scores">';
        html+='Flavor: '+j.flavor+' ('+j.flavorIntensity+') | ';
        html+='Aftertaste: '+j.aftertaste+' ('+j.aftertastePersistence+') | ';
        html+='Acidity: '+j.acidity+' ('+j.acidityIntensity+') | ';
        html+='Body: '+j.body+' ('+j.bodyIntensity+') | ';
        html+='Sweetness: '+(j.sweetness*2).toFixed(2)+' ('+j.sweetnessIntensity+') | ';
        html+='Overall: '+j.overall;
        html+='</div>';
        html+='<div style="margin-top:12px;padding-top:12px;border-top:1px solid #333">';
        html+='<div style="font-size:12px;color:#999;margin-bottom:4px">Flavor: '+j.notes.flavor+'</div>';
        html+='<div style="font-size:12px;color:#999;margin-bottom:4px">Aftertaste: '+j.notes.aftertaste+'</div>';
        html+='<div style="font-size:12px;color:#999;margin-bottom:4px">Acidity: '+j.notes.acidity+'</div>';
        html+='<div style="font-size:12px;color:#999;margin-bottom:4px">Body: '+j.notes.body+'</div>';
        html+='<div style="font-size:12px;color:#999;margin-bottom:4px">Sweetness: '+j.notes.sweetness+'</div>';
        html+='<div style="font-size:12px;color:#999">Overall: '+j.notes.overall+'</div>';
        html+='</div></div>';
      });
      document.getElementById('calResultArea').innerHTML=html;
      showScreen('calResultScreen');
    })
    .withFailureHandler(function(err){hideOverlay();showToast('ì˜¤ë¥˜: '+err,true)})
    .getCalibrationResultsByCup(cupNum);
}

function loadReviews(){
  showOverlay();
  google.script.run
    .withSuccessHandler(function(list){
      hideOverlay();
      if(!list||list.length===0){showToast('ê²€ìˆ˜ ëŒ€ê¸° í‰ê°€ê°€ ì—†ìŠµë‹ˆë‹¤',true);return}
      var html='';
      list.forEach(function(item){
        html+='<div class="review-item" onclick="loadReviewDetail('+item.cup+')">';
        html+='<h3>Cup '+item.cup+'</h3></div>';
      });
      document.getElementById('reviewListArea').innerHTML=html;
      showScreen('reviewListScreen');
    })
    .withFailureHandler(function(err){hideOverlay();showToast('ì˜¤ë¥˜: '+err,true)})
    .getMyPendingReviews(currentUser.userID);
}

function loadReviewDetail(cup){
  showOverlay();
  google.script.run
    .withSuccessHandler(function(data){
      hideOverlay();
      if(!data){showToast('ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤',true);return}
      currentReviewData={cup:cup,data:data};
      var html='<h3 style="text-align:center;margin-bottom:24px">Cup '+cup+' ê²€ìˆ˜ ë° ìˆ˜ì •</h3>';
      html+='<div class="review-attr"><h4>Flavor</h4>';
      html+='<div class="score-display" id="reviewFlavorDisplay">'+data.flavor.toFixed(2)+'</div>';
      html+='<div class="score-meaning">('+getScoreMeaning(data.flavor)+')</div>';
      html+='<input type="range" class="score-slider" id="reviewFlavorSlider" min="0" max="5" step="0.25" value="'+data.flavor+'" oninput="updateReviewScore(\'flavor\',this.value)">';
      html+='<div class="score-labels"><span>0</span><span>1</span><span>2</span><span>3</span><span>4</span><span>5</span></div>';
      html+='<div class="intensity-label">ê°•ë„</div><div class="intensity-grid" id="reviewFlavorIntensityGrid">';
      for(var i=1;i<=7;i++){
        var sel=(data.flavorIntensity==i)?'selected':'';
        html+='<div class="intensity-btn '+sel+'" onclick="updateReviewIntensity(\'flavor\','+i+')">'+INTENSITY_LEVELS[i].label+'<br>('+i+')</div>';
      }
      html+='</div>';
      html+='<label style="color:#999;font-size:12px;margin-top:16px;display:block">ì½”ë©˜íŠ¸</label>';
      html+='<textarea id="reviewNoteFlavor">'+data.noteFlavor+'</textarea></div>';
      html+='<div class="review-attr"><h4>Aftertaste</h4>';
      html+='<div class="score-display" id="reviewAftertasteDisplay">'+data.aftertaste.toFixed(2)+'</div>';
      html+='<div class="score-meaning">('+getScoreMeaning(data.aftertaste)+')</div>';
      html+='<input type="range" class="score-slider" id="reviewAftertasteSlider" min="0" max="5" step="0.25" value="'+data.aftertaste+'" oninput="updateReviewScore(\'aftertaste\',this.value)">';
      html+='<div class="score-labels"><span>0</span><span>1</span><span>2</span><span>3</span><span>4</span><span>5</span></div>';
      html+='<div class="intensity-label">ì§€ì†ì„±</div><div class="intensity-grid" id="reviewAftertastePersistenceGrid">';
      for(var i=1;i<=7;i++){
        var sel=(data.aftertastePersistence==i)?'selected':'';
        html+='<div class="intensity-btn '+sel+'" onclick="updateReviewIntensity(\'aftertaste\','+i+')">'+INTENSITY_LEVELS[i].label+'<br>('+i+')</div>';
      }
      html+='</div>';
      html+='<label style="color:#999;font-size:12px;margin-top:16px;display:block">ì½”ë©˜íŠ¸</label>';
      html+='<textarea id="reviewNoteAftertaste">'+data.noteAftertaste+'</textarea></div>';
      html+='<div class="review-attr"><h4>Acidity</h4>';
      html+='<div class="score-display" id="reviewAcidityDisplay">'+data.acidity.toFixed(2)+'</div>';
      html+='<div class="score-meaning">('+getScoreMeaning(data.acidity)+')</div>';
      html+='<input type="range" class="score-slider" id="reviewAciditySlider" min="0" max="5" step="0.25" value="'+data.acidity+'" oninput="updateReviewScore(\'acidity\',this.value)">';
      html+='<div class="score-labels"><span>0</span><span>1</span><span>2</span><span>3</span><span>4</span><span>5</span></div>';
      html+='<div class="intensity-label">ê°•ë„</div><div class="intensity-grid" id="reviewAcidityIntensityGrid">';
      for(var i=1;i<=7;i++){
        var sel=(data.acidityIntensity==i)?'selected':'';
        html+='<div class="intensity-btn '+sel+'" onclick="updateReviewIntensity(\'acidity\','+i+')">'+INTENSITY_LEVELS[i].label+'<br>('+i+')</div>';
      }
      html+='</div>';
      html+='<label style="color:#999;font-size:12px;margin-top:16px;display:block">ì½”ë©˜íŠ¸</label>';
      html+='<textarea id="reviewNoteAcidity">'+data.noteAcidity+'</textarea></div>';
      html+='<div class="review-attr"><h4>Body</h4>';
      html+='<div class="score-display" id="reviewBodyDisplay">'+data.body.toFixed(2)+'</div>';
      html+='<div class="score-meaning">('+getScoreMeaning(data.body)+')</div>';
      html+='<input type="range" class="score-slider" id="reviewBodySlider" min="0" max="5" step="0.25" value="'+data.body+'" oninput="updateReviewScore(\'body\',this.value)">';
      html+='<div class="score-labels"><span>0</span><span>1</span><span>2</span><span>3</span><span>4</span><span>5</span></div>';
      html+='<div class="intensity-label">ê°•ë„</div><div class="intensity-grid" id="reviewBodyIntensityGrid">';
      for(var i=1;i<=7;i++){
        var sel=(data.bodyIntensity==i)?'selected':'';
        html+='<div class="intensity-btn '+sel+'" onclick="updateReviewIntensity(\'body\','+i+')">'+INTENSITY_LEVELS[i].label+'<br>('+i+')</div>';
      }
      html+='</div>';
      html+='<label style="color:#999;font-size:12px;margin-top:16px;display:block">ì½”ë©˜íŠ¸</label>';
      html+='<textarea id="reviewNoteBody">'+data.noteBody+'</textarea></div>';
      html+='<div class="review-attr"><h4>Sweetness</h4>';
      html+='<div class="score-display" id="reviewSweetnessDisplay">'+data.sweetness.toFixed(2)+'</div>';
      html+='<div class="sweetness-multiplier">x2 = '+(data.sweetness*2).toFixed(2)+'ì </div>';
      html+='<div class="score-meaning">('+getScoreMeaning(data.sweetness)+')</div>';
      html+='<input type="range" class="score-slider" id="reviewSweetnessSlider" min="0" max="5" step="0.25" value="'+data.sweetness+'" oninput="updateReviewScore(\'sweetness\',this.value)">';
      html+='<div class="score-labels"><span>0</span><span>1</span><span>2</span><span>3</span><span>4</span><span>5</span></div>';
      html+='<div class="intensity-label">ê°•ë„</div><div class="intensity-grid" id="reviewSweetnessIntensityGrid">';
      for(var i=1;i<=7;i++){
        var sel=(data.sweetnessIntensity==i)?'selected':'';
        html+='<div class="intensity-btn '+sel+'" onclick="updateReviewIntensity(\'sweetness\','+i+')">'+INTENSITY_LEVELS[i].label+'<br>('+i+')</div>';
      }
      html+='</div>';
      html+='<label style="color:#999;font-size:12px;margin-top:16px;display:block">ì½”ë©˜íŠ¸</label>';
      html+='<textarea id="reviewNoteSweetness">'+data.noteSweetness+'</textarea></div>';
      html+='<div class="review-attr"><h4>Overall</h4>';
      html+='<div class="score-display" id="reviewOverallDisplay">'+data.overall.toFixed(2)+'</div>';
      html+='<div class="score-meaning">('+getScoreMeaning(data.overall)+')</div>';
      html+='<input type="range" class="score-slider" id="reviewOverallSlider" min="0" max="5" step="0.25" value="'+data.overall+'" oninput="updateReviewScore(\'overall\',this.value)">';
      html+='<div class="score-labels"><span>0</span><span>1</span><span>2</span><span>3</span><span>4</span><span>5</span></div>';
      html+='<label style="color:#999;font-size:12px;margin-top:16px;display:block">ì½”ë©˜íŠ¸</label>';
      html+='<textarea id="reviewNoteOverall">'+data.noteOverall+'</textarea></div>';
      document.getElementById('reviewDetailArea').innerHTML=html;
      showScreen('reviewDetailScreen');
    })
    .withFailureHandler(function(err){hideOverlay();showToast('ì˜¤ë¥˜: '+err,true)})
    .getMyScoreDetail(currentUser.userID,cup);
}

function updateReviewScore(attr,val){
  var display=document.getElementById('review'+attr.charAt(0).toUpperCase()+attr.slice(1)+'Display');
  if(display)display.textContent=parseFloat(val).toFixed(2);
  var meaning=display.nextElementSibling;
  if(meaning&&meaning.classList.contains('score-meaning')){meaning.textContent='('+getScoreMeaning(parseFloat(val))+')';}
  if(attr==='sweetness'){
    var multi=meaning.nextElementSibling;
    if(multi&&multi.classList.contains('sweetness-multiplier')){multi.textContent='x2 = '+(parseFloat(val)*2).toFixed(2)+'ì ';}
  }
}

function updateReviewIntensity(attr,val){
  var gridId='review'+(attr.charAt(0).toUpperCase()+attr.slice(1))+(attr==='aftertaste'?'Persistence':'Intensity')+'Grid';
  var grid=document.getElementById(gridId);
  if(!grid)return;
  var btns=grid.querySelectorAll('.intensity-btn');
  btns.forEach(function(btn,index){
    if(index+1===val)btn.classList.add('selected');
    else btn.classList.remove('selected');
  });
}

function saveReview(){
  if(!currentReviewData)return;
  var updatedData={
    flavor:parseFloat(document.getElementById('reviewFlavorSlider').value),
    flavorIntensity:parseInt(document.querySelector('#reviewFlavorIntensityGrid .intensity-btn.selected')?.innerText.match(/\((\d)\)/)?.[1]||4),
    noteFlavor:document.getElementById('reviewNoteFlavor').value,
    aftertaste:parseFloat(document.getElementById('reviewAftertasteSlider').value),
    aftertastePersistence:parseInt(document.querySelector('#reviewAftertastePersistenceGrid .intensity-btn.selected')?.innerText.match(/\((\d)\)/)?.[1]||4),
    noteAftertaste:document.getElementById('reviewNoteAftertaste').value,
    acidity:parseFloat(document.getElementById('reviewAciditySlider').value),
    acidityIntensity:parseInt(document.querySelector('#reviewAcidityIntensityGrid .intensity-btn.selected')?.innerText.match(/\((\d)\)/)?.[1]||4),
    noteAcidity:document.getElementById('reviewNoteAcidity').value,
    body:parseFloat(document.getElementById('reviewBodySlider').value),
    bodyIntensity:parseInt(document.querySelector('#reviewBodyIntensityGrid .intensity-btn.selected')?.innerText.match(/\((\d)\)/)?.[1]||4),
    noteBody:document.getElementById('reviewNoteBody').value,
    sweetness:parseFloat(document.getElementById('reviewSweetnessSlider').value),
    sweetnessIntensity:parseInt(document.querySelector('#reviewSweetnessIntensityGrid .intensity-btn.selected')?.innerText.match(/\((\d)\)/)?.[1]||4),
    noteSweetness:document.getElementById('reviewNoteSweetness').value,
    overall:parseFloat(document.getElementById('reviewOverallSlider').value),
    noteOverall:document.getElementById('reviewNoteOverall').value
  };
  showOverlay();
  google.script.run
    .withSuccessHandler(function(res){
      hideOverlay();
      if(res.success){showToast('ê²€ìˆ˜ ì™„ë£Œ!');backHome()}
      else{showToast(res.message||'ì €ì¥ ì‹¤íŒ¨',true)}
    })
    .withFailureHandler(function(err){hideOverlay();showToast('ì˜¤ë¥˜: '+err,true)})
    .updateScore(currentUser.userID,currentReviewData.cup,updatedData);
}

function backToReviewList(){currentReviewData=null;loadReviews()}

function refreshTop50(){
  showOverlay();
  google.script.run
    .withSuccessHandler(function(res){
      hideOverlay();
      if(!res.success||res.rankings.length===0){
        document.getElementById('top50Area').innerHTML='<p style="text-align:center;color:#999;padding:40px">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }
      var html='<div style="display:grid;gap:8px">';
      res.rankings.forEach(function(item,index){
        html+='<div class="review-item" onclick="loadCupDetail('+item.cup+')" style="cursor:pointer">';
        html+='<div style="display:flex;justify-content:space-between;align-items:center">';
        html+='<div><span style="color:#999;font-size:12px">'+(index+1)+'ìœ„</span> ';
        html+='<span style="font-size:18px;font-weight:700;margin-left:8px">Cup '+item.cup+'</span>';
        html+='<span style="font-size:12px;color:#999;margin-left:12px">('+item.judgeCount+'ëª… í‰ê°€)</span></div>';
        html+='<div style="font-size:24px;font-weight:700">'+item.sumTotal.toFixed(1)+'</div>';
        html+='</div></div>';
      });
      html+='</div>';
      document.getElementById('top50Area').innerHTML=html;
    })
    .withFailureHandler(function(err){hideOverlay()})
    .getTop50Rankings();
}

function loadAllCompletedReviews(){
  showOverlay();
  google.script.run
    .withSuccessHandler(function(list){
      hideOverlay();
      if(!list||list.length===0){
        document.getElementById('completedListArea').innerHTML='<p style="text-align:center;color:#999;padding:40px">ê²€ìˆ˜ ì™„ë£Œëœ í‰ê°€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        showScreen('completedListScreen');
        return;
      }
      var html='';
      list.forEach(function(item){
        html+='<div class="review-item" onclick="loadCompletedDetail('+item.cup+')">';
        html+='<h3>Cup '+item.cup+'</h3>';
        html+='<div style="font-size:14px;color:#999;margin-top:8px">í‰ê· : '+item.avgTotal.toFixed(2)+'ì  | í‰ê°€ì ìˆ˜: '+item.count+'ëª…</div>';
        html+='</div>';
      });
      document.getElementById('completedListArea').innerHTML=html;
      showScreen('completedListScreen');
    })
    .withFailureHandler(function(err){hideOverlay();showToast('ì˜¤ë¥˜: '+err,true)})
    .getAllCompletedReviews();
}

function loadCompletedDetail(cup){
  showOverlay();
  google.script.run
    .withSuccessHandler(function(results){
      hideOverlay();
      if(!results||results.length===0){showToast('í•´ë‹¹ ì»µì˜ í‰ê°€ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤',true);return}
      
      var html='<h3 style="text-align:center;margin-bottom:24px">Cup '+cup+' ê²€ìˆ˜ ì™„ë£Œ ìƒì„¸</h3>';
      
      var totals=results.map(function(j){return j.total});
      var avgTotal=totals.reduce(function(a,b){return a+b},0)/totals.length;
      var variance=totals.reduce(function(acc,val){return acc+Math.pow(val-avgTotal,2)},0)/totals.length;
      var stdDev=Math.sqrt(variance);
      
      var flavors=results.map(function(j){return j.flavor});
      var aftertastes=results.map(function(j){return j.aftertaste});
      var acidities=results.map(function(j){return j.acidity});
      var bodies=results.map(function(j){return j.body});
      var sweetnesses=results.map(function(j){return j.sweetness*2});
      var overalls=results.map(function(j){return j.overall});
      var calcStd=function(arr){var avg=arr.reduce(function(a,b){return a+b},0)/arr.length;var variance=arr.reduce(function(acc,val){return acc+Math.pow(val-avg,2)},0)/arr.length;return Math.sqrt(variance)};
      
      html+='<div class="cal-stats">';
      html+='<div class="cal-stats-title">í†µê³„ (í‰ê·  Â± í‘œì¤€í¸ì°¨)</div>';
      html+='<div class="cal-stats-row"><div>Total:</div><div>'+avgTotal.toFixed(2)+' Â± '+stdDev.toFixed(2)+'</div></div>';
      html+='<div class="cal-stats-row"><div>Flavor:</div><div>'+(flavors.reduce(function(a,b){return a+b},0)/flavors.length).toFixed(2)+' Â± '+calcStd(flavors).toFixed(2)+'</div></div>';
      html+='<div class="cal-stats-row"><div>Aftertaste:</div><div>'+(aftertastes.reduce(function(a,b){return a+b},0)/aftertastes.length).toFixed(2)+' Â± '+calcStd(aftertastes).toFixed(2)+'</div></div>';
      html+='<div class="cal-stats-row"><div>Acidity:</div><div>'+(acidities.reduce(function(a,b){return a+b},0)/acidities.length).toFixed(2)+' Â± '+calcStd(acidities).toFixed(2)+'</div></div>';
      html+='<div class="cal-stats-row"><div>Body:</div><div>'+(bodies.reduce(function(a,b){return a+b},0)/bodies.length).toFixed(2)+' Â± '+calcStd(bodies).toFixed(2)+'</div></div>';
      html+='<div class="cal-stats-row"><div>Sweetness:</div><div>'+(sweetnesses.reduce(function(a,b){return a+b},0)/sweetnesses.length).toFixed(2)+' Â± '+calcStd(sweetnesses).toFixed(2)+'</div></div>';
      html+='<div class="cal-stats-row"><div>Overall:</div><div>'+(overalls.reduce(function(a,b){return a+b},0)/overalls.length).toFixed(2)+' Â± '+calcStd(overalls).toFixed(2)+'</div></div>';
      html+='</div>';
      
      results.forEach(function(j){
        html+='<div class="cal-judge-row">';
        html+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">';
        html+='<div><strong>'+j.judgeName+'</strong>';
        
        var roleText='';
        if(j.role==='admin'){
          roleText='ê´€ë¦¬ì';
        }else if(j.role.indexOf('head')===0){
          var teamNum=j.role.replace('head','');
          roleText=teamNum?'í—¤ë“œì‹¬ì‚¬ìœ„ì› ('+teamNum+'íŒ€)':'í—¤ë“œì‹¬ì‚¬ìœ„ì›';
        }else if(j.role.indexOf('judge')===0){
          var teamNum=j.role.replace('judge','');
          roleText=teamNum?'ì‹¬ì‚¬ìœ„ì› ('+teamNum+'íŒ€)':'ì‹¬ì‚¬ìœ„ì›';
        }else{
          roleText='ì‹¬ì‚¬ìœ„ì›';
        }
        html+='<span class="role-badge">'+roleText+'</span>';
        
        html+='</div>';
        html+='<div style="font-size:24px;font-weight:700">'+j.total.toFixed(2)+'</div>';
        html+='</div>';
        html+='<div class="cal-scores">';
        html+='Flavor: '+j.flavor+' ('+j.flavorIntensity+') | ';
        html+='Aftertaste: '+j.aftertaste+' ('+j.aftertastePersistence+') | ';
        html+='Acidity: '+j.acidity+' ('+j.acidityIntensity+') | ';
        html+='Body: '+j.body+' ('+j.bodyIntensity+') | ';
        html+='Sweetness: '+(j.sweetness*2).toFixed(2)+' ('+j.sweetnessIntensity+') | ';
        html+='Overall: '+j.overall;
        html+='</div>';
        html+='<div style="margin-top:12px;padding-top:12px;border-top:1px solid #333">';
        html+='<div style="font-size:12px;color:#999;margin-bottom:4px">Flavor: '+j.notes.flavor+'</div>';
        html+='<div style="font-size:12px;color:#999;margin-bottom:4px">Aftertaste: '+j.notes.aftertaste+'</div>';
        html+='<div style="font-size:12px;color:#999;margin-bottom:4px">Acidity: '+j.notes.acidity+'</div>';
        html+='<div style="font-size:12px;color:#999;margin-bottom:4px">Body: '+j.notes.body+'</div>';
        html+='<div style="font-size:12px;color:#999;margin-bottom:4px">Sweetness: '+j.notes.sweetness+'</div>';
        html+='<div style="font-size:12px;color:#999">Overall: '+j.notes.overall+'</div>';
        html+='</div></div>';
      });
      
      document.getElementById('completedDetailArea').innerHTML=html;
      showScreen('completedDetailScreen');
    })
    .withFailureHandler(function(err){hideOverlay();showToast('ì˜¤ë¥˜: '+err,true)})
    .getCompletedDetailByCup(cup);
}

function backHome(){
  currentReviewData=null;
  currentCupDetailData=null;
  if(currentUser.role==='admin'){showScreen('adminScreen');refreshTop50()}
  else if(currentUser.role.indexOf('head')===0){showScreen('headScreen')}
  else{showScreen('judgeScreen')}
}

// ===== v3.0: ìë™ì €ì¥ ê¸°ëŠ¥ =====
function startAutoSave(){
  stopAutoSave();
  autoSaveTimer=setInterval(function(){
    if(evalData.cups&&evalData.cups.length>0){
      saveEvalState();
      showAutoSave();
    }
  },30000);
}

function stopAutoSave(){
  if(autoSaveTimer){
    clearInterval(autoSaveTimer);
    autoSaveTimer=null;
  }
}

function showAutoSave(){
  var indicator=document.getElementById('autoSaveIndicator');
  if(indicator){
    indicator.classList.add('active');
    setTimeout(function(){indicator.classList.remove('active')},2000);
  }
}

// ===== v3.0: ì»µë³„ ìƒì„¸ í‰ê°€ í‘œì‹œ =====
function loadCupDetail(cupNum){
  showOverlay();
  google.script.run
    .withSuccessHandler(function(evaluations){
      hideOverlay();
      if(!evaluations||evaluations.length===0){
        showToast('í•´ë‹¹ ì»µì˜ í‰ê°€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤',true);
        return;
      }
      
      currentCupDetailData={cup:cupNum,evaluations:evaluations};
      
      var html='<h3 style="text-align:center;margin-bottom:24px">Cup '+cupNum+' - ì „ì²´ í‰ê°€</h3>';
      
      html+='<div class="cal-stats">';
      html+='<div class="cal-stats-title">í‰ê°€ì: '+evaluations.length+'ëª…</div>';
      html+='</div>';
      
      evaluations.forEach(function(ev){
        html+='<div class="cup-detail-card">';
        html+='<div class="cup-detail-header">';
        html+='<div class="cup-detail-judge">'+ev.judgeName+'</div>';
        html+='<div class="cup-detail-total">'+ev.total.toFixed(2)+'</div>';
        html+='</div>';
        html+='<div class="cup-detail-scores">';
        html+='<div class="cup-detail-score-item"><div class="cup-detail-score-label">Flavor</div><div class="cup-detail-score-value">'+ev.flavor+' ('+ev.flavorIntensity+')</div></div>';
        html+='<div class="cup-detail-score-item"><div class="cup-detail-score-label">Aftertaste</div><div class="cup-detail-score-value">'+ev.aftertaste+' ('+ev.aftertastePersistence+')</div></div>';
        html+='<div class="cup-detail-score-item"><div class="cup-detail-score-label">Acidity</div><div class="cup-detail-score-value">'+ev.acidity+' ('+ev.acidityIntensity+')</div></div>';
        html+='<div class="cup-detail-score-item"><div class="cup-detail-score-label">Body</div><div class="cup-detail-score-value">'+ev.body+' ('+ev.bodyIntensity+')</div></div>';
        html+='<div class="cup-detail-score-item"><div class="cup-detail-score-label">Sweetness</div><div class="cup-detail-score-value">'+(ev.sweetness*2).toFixed(2)+' ('+ev.sweetnessIntensity+')</div></div>';
        html+='<div class="cup-detail-score-item"><div class="cup-detail-score-label">Overall</div><div class="cup-detail-score-value">'+ev.overall+'</div></div>';
        html+='</div>';
        html+='<div class="cup-detail-comments">';
        html+='<div class="cup-detail-comment"><strong>Flavor:</strong> '+ev.notes.flavor+'</div>';
        html+='<div class="cup-detail-comment"><strong>Aftertaste:</strong> '+ev.notes.aftertaste+'</div>';
        html+='<div class="cup-detail-comment"><strong>Acidity:</strong> '+ev.notes.acidity+'</div>';
        html+='<div class="cup-detail-comment"><strong>Body:</strong> '+ev.notes.body+'</div>';
        html+='<div class="cup-detail-comment"><strong>Sweetness:</strong> '+ev.notes.sweetness+'</div>';
        html+='<div class="cup-detail-comment"><strong>Overall:</strong> '+ev.notes.overall+'</div>';
        html+='</div></div>';
      });
      
      document.getElementById('cupDetailArea').innerHTML=html;
      showScreen('cupDetailScreen');
    })
    .withFailureHandler(function(err){hideOverlay();showToast('ì˜¤ë¥˜: '+err,true)})
    .getAllCupEvaluations(cupNum);
}

// ===== v3.0: PDF ë‹¤ìš´ë¡œë“œ (í•œê¸€ ì§€ì›) =====
function downloadPDF(){
  if(!window.jspdf||!window.jspdf.jsPDF){
    showToast('PDF ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© ì¤‘...',true);
    return;
  }
  
  showOverlay();
  
  // TOP 50 ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
  google.script.run
    .withSuccessHandler(function(res){
      if(!res.success||res.rankings.length===0){
        hideOverlay();
        showToast('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤',true);
        return;
      }
      
      // ì„ì‹œ HTML ìƒì„±
      var tempDiv=document.createElement('div');
      tempDiv.style.cssText='position:absolute;left:-9999px;width:800px;background:#fff;color:#000;padding:40px;font-family:Arial,sans-serif';
      tempDiv.innerHTML='<h1 style="text-align:center;margin-bottom:30px;font-size:24px">KCR Cupping App - TOP 20 Rankings</h1>';
      
      var table='<table style="width:100%;border-collapse:collapse">';
      table+='<thead><tr style="background:#000;color:#fff"><th style="padding:12px;border:1px solid #333">Rank</th><th style="padding:12px;border:1px solid #333">Cup</th><th style="padding:12px;border:1px solid #333">Total Score</th><th style="padding:12px;border:1px solid #333">Judges</th></tr></thead><tbody>';
      
      res.rankings.forEach(function(item,index){
        table+='<tr><td style="padding:10px;border:1px solid #ddd;text-align:center">'+(index+1)+'</td>';
        table+='<td style="padding:10px;border:1px solid #ddd;text-align:center">Cup '+item.cup+'</td>';
        table+='<td style="padding:10px;border:1px solid #ddd;text-align:center;font-weight:bold">'+item.sumTotal.toFixed(1)+'</td>';
        table+='<td style="padding:10px;border:1px solid #ddd;text-align:center">'+item.judgeCount+'</td></tr>';
      });
      
      table+='</tbody></table>';
      tempDiv.innerHTML+=table;
      document.body.appendChild(tempDiv);
      
      // html2canvasë¡œ ìº¡ì²˜
      html2canvas(tempDiv,{scale:2,backgroundColor:'#ffffff'}).then(function(canvas){
        document.body.removeChild(tempDiv);
        
        var imgData=canvas.toDataURL('image/png');
        var doc=new window.jspdf.jsPDF('p','mm','a4');
        var imgWidth=210;
        var pageHeight=297;
        var imgHeight=canvas.height*imgWidth/canvas.width;
        var heightLeft=imgHeight;
        var position=0;
        
        doc.addImage(imgData,'PNG',0,position,imgWidth,imgHeight);
        heightLeft-=pageHeight;
        
        while(heightLeft>=0){
          position=heightLeft-imgHeight;
          doc.addPage();
          doc.addImage(imgData,'PNG',0,position,imgWidth,imgHeight);
          heightLeft-=pageHeight;
        }
        
        doc.save('KCR_Top20_'+new Date().toISOString().slice(0,10)+'.pdf');
        hideOverlay();
        showToast('PDF ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!');
      }).catch(function(err){
        document.body.removeChild(tempDiv);
        hideOverlay();
        showToast('PDF ìƒì„± ì˜¤ë¥˜: '+err,true);
      });
    })
    .withFailureHandler(function(err){hideOverlay();showToast('ì˜¤ë¥˜: '+err,true)})
    .getTop50Rankings();
}

function downloadCupPDF(){
  if(!currentCupDetailData||!window.jspdf||!window.jspdf.jsPDF||!window.html2canvas){
    showToast('PDF ìƒì„± ì¤€ë¹„ ì¤‘...',true);
    return;
  }
  
  showOverlay();
  
  var evaluations=currentCupDetailData.evaluations;
  var cupNum=currentCupDetailData.cup;
  var process=evaluations.length>0?evaluations[0].process:'';
  
  // A4 ë””ë¸Œë¦¬í•‘ìš© HTML ìƒì„±
  var tempDiv=document.createElement('div');
  tempDiv.style.cssText='position:absolute;left:-9999px;width:800px;background:#fff;color:#000;padding:30px;font-family:Arial,sans-serif;box-sizing:border-box';
  
  var html='<div style="margin-bottom:20px">';
  html+='<h1 style="text-align:center;font-size:28px;margin:0 0 8px 0;font-weight:bold">Cup '+cupNum+' - Evaluation Report</h1>';
  html+='<div style="text-align:center;font-size:14px;color:#666;margin-bottom:5px">í‰ê°€ì: '+evaluations.length+'ëª…</div>';
  if(process){
    html+='<div style="text-align:center;font-size:13px;color:#333;font-weight:bold;margin-bottom:15px">'+process+' Process</div>';
  }else{
    html+='<div style="margin-bottom:10px"></div>';
  }
  html+='</div>';
  
  // í‰ê°€ìë³„ ì •ë³´ (4-5ëª…ì´ í•œ í˜ì´ì§€ì— ë“¤ì–´ê°€ë„ë¡ ì••ì¶•)
  html+='<table style="width:100%;border-collapse:collapse;font-size:11px">';
  html+='<thead><tr style="background:#000;color:#fff">';
  html+='<th style="padding:8px;border:1px solid #000;width:15%">í‰ê°€ì</th>';
  html+='<th style="padding:8px;border:1px solid #000;width:8%">ì´ì </th>';
  html+='<th style="padding:8px;border:1px solid #000;width:8%">Flavor<br><span style="font-size:9px;font-weight:normal">/5</span></th>';
  html+='<th style="padding:8px;border:1px solid #000;width:8%">After<br><span style="font-size:9px;font-weight:normal">/5</span></th>';
  html+='<th style="padding:8px;border:1px solid #000;width:8%">Acid<br><span style="font-size:9px;font-weight:normal">/5</span></th>';
  html+='<th style="padding:8px;border:1px solid #000;width:8%">Body<br><span style="font-size:9px;font-weight:normal">/5</span></th>';
  html+='<th style="padding:8px;border:1px solid #000;width:8%">Sweet<br><span style="font-size:9px;font-weight:normal">/10</span></th>';
  html+='<th style="padding:8px;border:1px solid #000;width:8%">Overall<br><span style="font-size:9px;font-weight:normal">/5</span></th>';
  html+='</tr></thead><tbody>';
  
  evaluations.forEach(function(ev,idx){
    var bgColor=idx%2===0?'#f9f9f9':'#fff';
    var roleText=ev.judgeRole==='head'?'(í—¤ë“œ)':'(ì‹¬ì‚¬ìœ„ì›)';
    html+='<tr style="background:'+bgColor+'">';
    html+='<td style="padding:6px;border:1px solid #ddd;font-weight:bold">'+ev.judgeName+'<br><span style="font-size:9px;color:#666">'+roleText+'</span></td>';
    html+='<td style="padding:6px;border:1px solid #ddd;text-align:center;font-weight:bold;font-size:14px;background:#000;color:#fff">'+ev.total.toFixed(1)+'</td>';
    html+='<td style="padding:6px;border:1px solid #ddd;text-align:center">'+ev.flavor+'<br><span style="color:#999;font-size:8px">ê°•ë„:'+ev.flavorIntensity+'</span></td>';
    html+='<td style="padding:6px;border:1px solid #ddd;text-align:center">'+ev.aftertaste+'<br><span style="color:#999;font-size:8px">ì§€ì†:'+ev.aftertastePersistence+'</span></td>';
    html+='<td style="padding:6px;border:1px solid #ddd;text-align:center">'+ev.acidity+'<br><span style="color:#999;font-size:8px">ê°•ë„:'+ev.acidityIntensity+'</span></td>';
    html+='<td style="padding:6px;border:1px solid #ddd;text-align:center">'+ev.body+'<br><span style="color:#999;font-size:8px">ê°•ë„:'+ev.bodyIntensity+'</span></td>';
    html+='<td style="padding:6px;border:1px solid #ddd;text-align:center">'+(ev.sweetness*2).toFixed(1)+'<br><span style="color:#999;font-size:8px">ê°•ë„:'+ev.sweetnessIntensity+'</span></td>';
    html+='<td style="padding:6px;border:1px solid #ddd;text-align:center">'+ev.overall+'</td>';
    html+='</tr>';
  });
  html+='</tbody></table>';
  
  // ì½”ë©˜íŠ¸ ì„¹ì…˜ (ì••ì¶•)
  html+='<div style="margin-top:20px">';
  html+='<h3 style="font-size:14px;margin:0 0 10px 0;font-weight:bold;border-bottom:2px solid #000;padding-bottom:5px">í‰ê°€ ì½”ë©˜íŠ¸</h3>';
  
  evaluations.forEach(function(ev){
    var roleText=ev.judgeRole==='head'?'í—¤ë“œì‹¬ì‚¬ìœ„ì›':'ì‹¬ì‚¬ìœ„ì›';
    html+='<div style="margin-bottom:12px;padding:10px;background:#f5f5f5;border-left:3px solid #000">';
    html+='<div style="font-weight:bold;margin-bottom:6px;font-size:12px">'+ev.judgeName+' ('+roleText+', '+ev.total.toFixed(1)+'ì )</div>';
    html+='<div style="font-size:9px;line-height:1.4;color:#333">';
    html+='<div style="margin-bottom:3px"><strong>Flavor:</strong> '+ev.notes.flavor+'</div>';
    html+='<div style="margin-bottom:3px"><strong>Aftertaste:</strong> '+ev.notes.aftertaste+'</div>';
    html+='<div style="margin-bottom:3px"><strong>Acidity:</strong> '+ev.notes.acidity+'</div>';
    html+='<div style="margin-bottom:3px"><strong>Body:</strong> '+ev.notes.body+'</div>';
    html+='<div style="margin-bottom:3px"><strong>Sweetness:</strong> '+ev.notes.sweetness+'</div>';
    html+='<div><strong>Overall:</strong> '+ev.notes.overall+'</div>';
    html+='</div></div>';
  });
  html+='</div>';
  
  tempDiv.innerHTML=html;
  document.body.appendChild(tempDiv);
  
  // html2canvasë¡œ ìº¡ì²˜ (A4 ìµœì í™”)
  html2canvas(tempDiv,{
    scale:2,
    backgroundColor:'#ffffff',
    width:800,
    windowWidth:800
  }).then(function(canvas){
    document.body.removeChild(tempDiv);
    
    var imgData=canvas.toDataURL('image/png');
    var doc=new window.jspdf.jsPDF('p','mm','a4');
    
    // A4 í¬ê¸°: 210mm x 297mm
    var pdfWidth=210;
    var pdfHeight=297;
    var imgWidth=pdfWidth;
    var imgHeight=canvas.height*pdfWidth/canvas.width;
    
    // ì´ë¯¸ì§€ê°€ A4ë³´ë‹¤ ê¸¸ë©´ ìë™ìœ¼ë¡œ ì¶•ì†Œ
    if(imgHeight>pdfHeight){
      imgHeight=pdfHeight;
      imgWidth=canvas.width*pdfHeight/canvas.height;
    }
    
    // ì¤‘ì•™ ì •ë ¬
    var xOffset=(pdfWidth-imgWidth)/2;
    
    doc.addImage(imgData,'PNG',xOffset,0,imgWidth,imgHeight);
    
    doc.save('KCR_Cup'+cupNum+'_Debriefing_'+new Date().toISOString().slice(0,10)+'.pdf');
    hideOverlay();
    showToast('ë””ë¸Œë¦¬í•‘ PDF ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!');
  }).catch(function(err){
    if(document.body.contains(tempDiv)){
      document.body.removeChild(tempDiv);
    }
    hideOverlay();
    showToast('PDF ìƒì„± ì˜¤ë¥˜: '+err,true);
  });
}
</script>
</body>
</html>
